<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Football Admin Dashboard</title>
  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome (icons) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    .connection-status { @apply flex items-center gap-2 text-sm px-2 py-1 rounded-full; }
    .connected   { @apply bg-green-100 text-green-700; }
    .disconnected{ @apply bg-yellow-100 text-yellow-700; }
    .error-banner{ @apply hidden mt-2 text-sm text-red-700 bg-red-100 border border-red-200 rounded p-2; }
    .loader      { @apply hidden text-sm text-gray-500; }
    .hidden-section { display: none; }
    .active-nav-item { @apply bg-slate-700; }
  </style>
</head>
<body class="min-h-screen bg-slate-50 flex">
  <!-- Sidebar (updated with Scouts and Clubs) -->
  <aside class="w-64 bg-slate-800 text-white min-h-screen p-4 hidden md:block">
    <h2 class="text-xl font-bold mb-6">Dashboard</h2>
    <nav class="space-y-2">
      <a href="#overview" class="nav-item block px-3 py-2 rounded hover:bg-slate-700"><i class="fa-solid fa-gauge mr-2"></i>Overview</a>
      <a href="#players" class="nav-item block px-3 py-2 rounded hover:bg-slate-700"><i class="fa-solid fa-users mr-2"></i>Players</a>
      <a href="#scouts" class="nav-item block px-3 py-2 rounded hover:bg-slate-700"><i class="fa-solid fa-user-secret mr-2"></i>Scouts</a>
      <a href="#clubs" class="nav-item block px-3 py-2 rounded hover:bg-slate-700"><i class="fa-solid fa-building mr-2"></i>Clubs</a>
      <a href="#reports" class="nav-item block px-3 py-2 rounded hover:bg-slate-700"><i class="fa-solid fa-clipboard-list mr-2"></i>Reports</a>
      <a href="#addEdit" class="nav-item block px-3 py-2 rounded hover:bg-slate-700"><i class="fa-solid fa-plus mr-2"></i>Add / Edit Player</a>
    </nav>
  </aside>

  <!-- Main content -->
  <div class="flex-1 flex flex-col">
    <!-- Top bar -->
    <header class="w-full bg-white border-b border-slate-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
        <h1 class="text-xl font-semibold text-slate-800">Admin Dashboard</h1>
        <div class="flex items-center gap-4">
          <!-- API Mode toggle -->
          <label class="inline-flex items-center cursor-pointer select-none">
            <input type="checkbox" id="apiToggle" class="sr-only" />
            <span class="mr-2 text-sm text-slate-600">API Mode</span>
            <span class="relative">
              <span class="block w-12 h-7 bg-slate-300 rounded-full shadow-inner"></span>
              <span id="apiKnob" class="absolute block w-6 h-6 bg-white rounded-full shadow -left-0.5 top-0.5 transition"></span>
            </span>
          </label>
          <div id="connectionStatus" class="connection-status disconnected">
            <i class="fas fa-plug"></i><span>Using Demo Data</span>
          </div>
        </div>
      </div>
    </header>

    <main class="flex-1 overflow-y-auto max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <!-- KPI Cards -->
      <section id="overview" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="bg-white rounded-2xl shadow p-4">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-slate-500">Players</p>
              <p class="text-3xl font-bold text-slate-800"><span id="playersCount">0</span></p>
            </div>
            <div class="text-sky-600 text-2xl"><i class="fa-solid fa-users"></i></div>
          </div>
        </div>
        <div class="bg-white rounded-2xl shadow p-4">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-slate-500">Reports</p>
              <p class="text-3xl font-bold text-slate-800"><span id="reportsCount">0</span></p>
            </div>
            <div class="text-emerald-600 text-2xl"><i class="fa-solid fa-clipboard-list"></i></div>
          </div>
        </div>
        <div class="bg-white rounded-2xl shadow p-4">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-slate-500">Clubs</p>
              <p class="text-3xl font-bold text-slate-800"><span id="clubsCount">0</span></p>
            </div>
            <div class="text-indigo-600 text-2xl"><i class="fa-solid fa-building"></i></div>
          </div>
        </div>
        <div class="bg-white rounded-2xl shadow p-4">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-slate-500">Scouts</p>
              <p class="text-3xl font-bold text-slate-800"><span id="scoutsCount">0</span></p>
            </div>
            <div class="text-rose-600 text-2xl"><i class="fa-solid fa-user-secret"></i></div>
          </div>
        </div>
      </section>

      <!-- Charts -->
      <section id="reports" class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-6">
        <div class="bg-white rounded-2xl shadow p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-semibold text-slate-800">Positions Breakdown</h2>
          </div>
          <canvas id="positionsChart" height="140"></canvas>
        </div>
        <div class="bg-white rounded-2xl shadow p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-semibold text-slate-800">Weekly Activity</h2>
          </div>
          <canvas id="activityChart" height="140"></canvas>
        </div>
      </section>

      <!-- Player Management -->
      <section id="players" class="bg-white rounded-2xl shadow mt-6">
        <div class="p-4 border-b border-slate-200 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
          <h2 class="text-lg font-semibold text-slate-800">Player Management</h2>
          <div class="flex items-center gap-2">
            <div class="relative">
              <input id="searchInput" type="text" placeholder="Search players by name, position or club..." class="w-64 border border-slate-200 rounded-xl py-2 pl-9 pr-3 text-sm focus:ring-2 focus:ring-sky-400 focus:outline-none" />
              <i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-slate-400"></i>
            </div>
            <button id="addPlayerBtn" class="inline-flex items-center gap-2 bg-sky-600 text-white text-sm font-medium px-3 py-2 rounded-xl hover:bg-sky-700">
              <i class="fa-solid fa-plus"></i> New Player
            </button>
          </div>
        </div>

        <div id="playersError" class="error-banner mx-4">Failed to load player data. Using demo data instead.</div>

        <div class="p-4">
          <div id="playersLoader" class="loader">Loading players…</div>
          <div class="overflow-x-auto">
            <table id="playersTable" class="min-w-full text-sm">
              <thead>
                <tr class="text-left text-slate-600 border-b">
                  <th class="py-2 pr-4">Name</th>
                  <th class="py-2 pr-4">Age</th>
                  <th class="py-2 pr-4">Position</th>
                  <th class="py-2 pr-4">Rating</th>
                  <th class="py-2 pr-4">Club</th>
                  <th class="py-2 pr-4">Nationality</th>
                  <th class="py-2 pr-4">Actions</th>
                </tr>
              </thead>
              <tbody id="playersTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Scouts Section (Hidden by default) -->
      <section id="scouts" class="hidden-section bg-white rounded-2xl shadow mt-6">
        <div class="p-4 border-b border-slate-200 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
          <h2 class="text-lg font-semibold text-slate-800">Scout Management</h2>
          <div class="flex items-center gap-2">
            <div class="relative">
              <input id="scoutSearchInput" type="text" placeholder="Search scouts by name or region..." class="w-64 border border-slate-200 rounded-xl py-2 pl-9 pr-3 text-sm focus:ring-2 focus:ring-sky-400 focus:outline-none" />
              <i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-slate-400"></i>
            </div>
            <button id="addScoutBtn" class="inline-flex items-center gap-2 bg-sky-600 text-white text-sm font-medium px-3 py-2 rounded-xl hover:bg-sky-700">
              <i class="fa-solid fa-plus"></i> New Scout
            </button>
          </div>
        </div>

        <div class="p-4">
          <div class="overflow-x-auto">
            <table id="scoutsTable" class="min-w-full text-sm">
              <thead>
                <tr class="text-left text-slate-600 border-b">
                  <th class="py-2 pr-4">Name</th>
                  <th class="py-2 pr-4">Region</th>
                  <th class="py-2 pr-4">Experience</th>
                  <th class="py-2 pr-4">Status</th>
                  <th class="py-2 pr-4">Players Found</th>
                  <th class="py-2 pr-4">Actions</th>
                </tr>
              </thead>
              <tbody id="scoutsTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Clubs Section (Hidden by default) -->
      <section id="clubs" class="hidden-section bg-white rounded-2xl shadow mt-6">
        <div class="p-4 border-b border-slate-200">
          <h2 class="text-lg font-semibold text-slate-800">Club Management</h2>
        </div>
        <div class="p-4">
          <p class="text-slate-600">Club management functionality will be implemented here.</p>
          <!-- Club management content will go here -->
        </div>
      </section>

      <!-- Add/Edit Player FORM at the END of the page -->
      <section id="addEdit" class="bg-white rounded-2xl shadow mt-6 p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 id="formTitle" class="text-lg font-semibold text-slate-800">Add Player</h3>
          <button id="resetFormBtn" class="text-sm text-slate-600 hover:text-slate-800"><i class="fa-solid fa-rotate-left mr-1"></i>Reset</button>
        </div>
        <form id="playerForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="hidden" id="playerId" />
          <div>
            <label class="block text-sm text-slate-600 mb-1">Name</label>
            <input id="name" class="w-full border border-slate-200 rounded-xl px-3 py-2" required />
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">Age</label>
            <input id="age" type="number" min="18" max="45" class="w-full border border-slate-200 rounded-xl px-3 py-2" />
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">Position</label>
            <select id="position" class="w-full border border-slate-200 rounded-xl px-3 py-2">
              <option>GK</option>
              <option>DEF</option>
              <option>MID</option>
              <option>FWD</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">Rating</label>
            <input id="rating" type="number" step="0.1" min="0" max="10" class="w-full border border-slate-200 rounded-xl px-3 py-2" />
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">Club</label>
            <input id="club" class="w-full border border-slate-200 rounded-xl px-3 py-2" />
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">Nationality</label>
            <select id="nationality" class="w-full border border-slate-200 rounded-xl px-3 py-2">
              <option value="ARG">Argentina</option>
              <option value="BRA">Brazil</option>
              <option value="ENG">England</option>
              <option value="FRA">France</option>
              <option value="GER">Germany</option>
              <option value="ITA">Italy</option>
              <option value="NED">Netherlands</option>
              <option value="POR">Portugal</option>
              <option value="ESP">Spain</option>
              <option value="URU">Uruguay</option>
            </select>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm text-slate-600 mb-1">Notes</label>
            <textarea id="notes" rows="3" class="w-full border border-slate-200 rounded-xl px-3 py-2"></textarea>
          </div>
          <div class="md:col-span-2 flex justify-end gap-2 mt-2">
            <button type="button" id="cancelEditBtn" class="px-4 py-2 rounded-xl border border-slate-200">Cancel</button>
            <button type="submit" class="px-4 py-2 rounded-xl bg-sky-600 text-white">Save</button>
          </div>
        </form>
      </section>
    </main>
  </div>

  <script>
  // =============================
  // API CONFIG
  // =============================
  const API_BASE = "https://players-flask-app.onrender.com"; // change if needed
  const ENDPOINTS = {
    players: `${API_BASE}/players`,
    playerReports: `${API_BASE}/player-reports`,
    scouts: `${API_BASE}/scouts`,
    clubs: `${API_BASE}/clubs`,
  };

  // =============================
  // STATE
  // =============================
  let apiMode = false; // toggled by switch
  let allPlayers = [];
  let allScouts = [];
  let currentPage = 1;
  let currentLimit = 50;
  let currentSearch = "";
  let activeSection = "overview"; // Track the active section

  // Demo data fallback
  const samplePlayers = [
    { name: "John Smith", age: 22, position: "MID", rating: 7.4, club: "City FC", nationality: "ENG" },
    { name: "Pedro Alvarez", age: 25, position: "FWD", rating: 8.1, club: "United SC", nationality: "ESP" },
    { name: "Sizwe Mokoena", age: 21, position: "DEF", rating: 7.2, club: "Soweto Stars", nationality: "RSA" },
    { name: "Marco Rossi", age: 28, position: "GK",  rating: 7.8, club: "Milano AC", nationality: "ITA" },
  ];

  // Dummy scouts data
  const dummyScouts = [
    { name: "James Wilson", region: "Europe", experience: "Senior", status: "Active", playersFound: 24 },
    { name: "Maria Rodriguez", region: "South America", experience: "Mid-level", status: "Active", playersFound: 18 },
    { name: "David Chen", region: "Asia", experience: "Junior", status: "Training", playersFound: 12 },
    { name: "Sarah Johnson", region: "North America", experience: "Senior", status: "Active", playersFound: 22 },
    { name: "Ahmed Hassan", region: "Africa", experience: "Mid-level", status: "On Leave", playersFound: 15 },
    { name: "Emma Thompson", region: "Europe", experience: "Senior", status: "Active", playersFound: 28 },
    { name: "Carlos Mendez", region: "Central America", experience: "Junior", status: "Active", playersFound: 9 },
    { name: "Lisa Brown", region: "Oceania", experience: "Mid-level", status: "Active", playersFound: 14 }
  ];

  // Available positions
  const positions = ["GK", "DEF", "MID", "FWD"];

  // Available nationalities with country codes and names
  const nationalities = [
    { code: "ARG", name: "Argentina" },
    { code: "BEL", name: "Belgium" },
    { code: "BRA", name: "Brazil" },
    { code: "COL", name: "Colombia" },
    { code: "CRO", name: "Croatia" },
    { code: "ENG", name: "England" },
    { code: "FRA", name: "France" },
    { code: "GER", name: "Germany" },
    { code: "ITA", name: "Italy" },
    { code: "NED", name: "Netherlands" },
    { code: "POR", name: "Portugal" },
    { code: "ESP", name: "Spain" },
    { code: "URU", name: "Uruguay" },
    { code: "USA", name: "United States" },
    { code: "RSA", name: "South Africa" },
    { code: "EGY", name: "Egypt" },
    { code: "NGA", name: "Nigeria" },
    { code: "JPN", name: "Japan" },
    { code: "KOR", name: "South Korea" },
    { code: "MEX", name: "Mexico" }
  ];

  // =============================
  // NORMALIZER (fix age + position + nationality)
  // =============================
  function normalizePlayer(p){
    // Generate a random age between 18 and 45
    let age = Math.floor(Math.random() * (45 - 18 + 1)) + 18;

    // Generate a random position
    let position = positions[Math.floor(Math.random() * positions.length)];

    // Generate a random nationality
    let nationality = nationalities[Math.floor(Math.random() * nationalities.length)].code;

    // Rating: coerce to number if numeric
    let rating = p.rating ?? p.Rating ?? p["Original Rating"] ?? p["Alternative Rating"];
    if (rating !== undefined && rating !== null && rating !== '') {
      const n = Number(rating);
      rating = isNaN(n) ? rating : n;
    }

    return {
      name: p.name || p.Name || 'N/A',
      age,
      position,
      rating: rating ?? 'N/A',
      club: p.club || p["Team Name"] || p.Team || 'N/A',
      nationality,
      notes: p.notes || p.Notes || ''
    };
  }

  // Helper function to get nationality name from code
  function getNationalityName(code) {
    const nationality = nationalities.find(n => n.code === code);
    return nationality ? nationality.name : code;
  }

  // =============================
  // HELPERS
  // =============================
  function $(id){ return document.getElementById(id); }

  function animateValue(el, start, end, duration) {
    const s = Number(start)||0, e = Number(end)||0, range = e - s;
    if (!range) { el.textContent = String(e); return; }
    const t0 = performance.now();
    function tick(t){
      const k = Math.min((t - t0) / duration, 1);
      el.textContent = String(Math.floor(s + range * k));
      if (k < 1) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  }

  function showLoader(loaderId, tableId){
    $(loaderId).classList.remove('hidden');
    $(tableId).classList.add('opacity-50');
  }
  function hideLoader(loaderId, tableId){
    $(loaderId).classList.add('hidden');
    $(tableId).classList.remove('opacity-50');
  }
  function showError(id, msg){ const el=$(id); el.textContent=msg; el.classList.remove('hidden'); }
  function hideError(id){ $(id).classList.add('hidden'); }

  function updatePlayerCount(n){
    const el = $('playersCount');
    animateValue(el, Number(el.textContent)||0, n, 800);
  }

  function displayPlayers(list){
    const tbody = $('playersTbody');
    tbody.innerHTML = '';
    list.forEach(p => {
      const tr = document.createElement('tr');
      tr.className = 'border-b hover:bg-slate-50';
      tr.innerHTML = `
        <td class="py-2 pr-4 font-medium text-slate-800">${p.name ?? 'N/A'}</td>
        <td class="py-2 pr-4">${p.age ?? '—'}</td>
        <td class="py-2 pr-4">${p.position ?? '—'}</td>
        <td class="py-2 pr-4">${p.rating ?? '—'}</td>
        <td class="py-2 pr-4">${p.club ?? '—'}</td>
        <td class="py-2 pr-4">${getNationalityName(p.nationality) ?? '—'}</td>
        <td class="py-2 pr-4">
          <button class="text-sky-600 hover:underline mr-2" onclick='populateForm(${JSON.stringify(JSON.stringify(p))})'>Edit</button>
          <button class="text-rose-600 hover:underline" onclick='deletePlayer(${JSON.stringify(JSON.stringify(p.name))})'>Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  function displayScouts(list){
    const tbody = $('scoutsTbody');
    tbody.innerHTML = '';
    list.forEach(s => {
      const tr = document.createElement('tr');
      tr.className = 'border-b hover:bg-slate-50';
      
      // Determine status color
      let statusColor = 'text-gray-600';
      if (s.status === 'Active') statusColor = 'text-green-600';
      if (s.status === 'On Leave') statusColor = 'text-yellow-600';
      if (s.status === 'Training') statusColor = 'text-blue-600';
      
      tr.innerHTML = `
        <td class="py-2 pr-4 font-medium text-slate-800">${s.name ?? 'N/A'}</td>
        <td class="py-2 pr-4">${s.region ?? '—'}</td>
        <td class="py-2 pr-4">${s.experience ?? '—'}</td>
        <td class="py-2 pr-4 ${statusColor}">${s.status ?? '—'}</td>
        <td class="py-2 pr-4">${s.playersFound ?? '—'}</td>
        <td class="py-2 pr-4">
          <button class="text-sky-600 hover:underline mr-2">Edit</button>
          <button class="text-rose-600 hover:underline">Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  // Calculate position counts for the chart
  function calculatePositionCounts(players) {
    const counts = {
      "GK": 0,
      "DEF": 0,
      "MID": 0,
      "FWD": 0
    };
    
    players.forEach(player => {
      if (player.position && counts.hasOwnProperty(player.position)) {
        counts[player.position]++;
      }
    });
    
    return counts;
  }

  // charts
  let positionsChart, activityChart;
  function createPositionChart(players){
    const ctx = document.getElementById('positionsChart');
    const positionCounts = calculatePositionCounts(players);
    const labels = Object.keys(positionCounts);
    const values = Object.values(positionCounts);
    
    // Define colors for each position
    const backgroundColors = [
      'rgba(255, 99, 132, 0.7)',  // GK - Pink
      'rgba(54, 162, 235, 0.7)',  // DEF - Blue
      'rgba(255, 206, 86, 0.7)',  // MID - Yellow
      'rgba(75, 192, 192, 0.7)'   // FWD - Teal
    ];
    
    if (positionsChart) positionsChart.destroy();
    positionsChart = new Chart(ctx, {
      type: 'doughnut',
      data: { 
        labels, 
        datasets: [{ 
          data: values,
          backgroundColor: backgroundColors,
          borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
          borderWidth: 1
        }] 
      },
      options: { 
        responsive: true, 
        plugins: { 
          legend: { 
            position: 'bottom' 
          } 
        } 
      }
    });
  }
  
  function createActivityChart(){
    const ctx = document.getElementById('activityChart');
    const labels = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    const values = labels.map(() => Math.floor(Math.random()*20)+5);
    if (activityChart) activityChart.destroy();
    activityChart = new Chart(ctx, {
      type: 'line',
      data: { 
        labels, 
        datasets: [{ 
          label: 'Events', 
          data: values, 
          tension: 0.35, 
          fill: true,
          backgroundColor: 'rgba(54, 162, 235, 0.2)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 2,
          pointBackgroundColor: 'rgba(54, 162, 235, 1)'
        }] 
      },
      options: { 
        responsive: true, 
        plugins: { 
          legend: { 
            display: false 
          } 
        } 
      }
    });
  }

  // =============================
  // SECTION NAVIGATION
  // =============================
  function showSection(sectionId) {
    // Hide all sections
    document.querySelectorAll('main > section').forEach(section => {
      section.classList.add('hidden-section');
    });
    
    // Show the selected section
    const targetSection = $(sectionId);
    if (targetSection) {
      targetSection.classList.remove('hidden-section');
    }
    
    // Update active nav item
    document.querySelectorAll('.nav-item').forEach(item => {
      item.classList.remove('active-nav-item');
    });
    
    const activeNavItem = document.querySelector(`.nav-item[href="#${sectionId}"]`);
    if (activeNavItem) {
      activeNavItem.classList.add('active-nav-item');
    }
    
    // Update active section
    activeSection = sectionId;
    
    // Load scouts if scouts section is shown
    if (sectionId === 'scouts') {
      loadScouts();
    }
  }

  // =============================
  // CORE LOADERS
  // =============================
  async function initDashboard(){
    try {
      // players widget + table (use API directly once to get counts)
      const resPlayers = await fetch(`${ENDPOINTS.players}?page=1&limit=50`);
      const playersPayload = await resPlayers.json(); // { total_players, players, ... }
      const total = Number(playersPayload?.total_players ?? 0);
      $('playersCount').textContent = total;
      animateValue($('playersCount'), 0, total, 1000);

      // placeholder KPIs
      $('reportsCount').textContent = String(Math.floor(Math.random()*10)+5);
      $('clubsCount').textContent = String(Math.floor(Math.random()*5)+1);
      $('scoutsCount').textContent = String(dummyScouts.length);

      animateValue($('reportsCount'), 0, Number($('reportsCount').textContent), 1000);
      animateValue($('clubsCount'),   0, Number($('clubsCount').textContent),   1000);
      animateValue($('scoutsCount'),  0, Number($('scoutsCount').textContent),  1000);

      await loadPlayers();
    } catch (err) {
      console.error('❌ Error loading dashboard:', err);
      allPlayers = [...samplePlayers];
      displayPlayers(allPlayers);
      updatePlayerCount(allPlayers.length);
      createPositionChart(allPlayers);
      createActivityChart();
    }
  }

  async function loadPlayers(){
    try {
      showLoader('playersLoader','playersTable');
      hideError('playersError');

      if (apiMode) {
        const qs = new URLSearchParams({
          page: String(currentPage),
          limit: String(currentLimit),
          ...(currentSearch ? { name: currentSearch } : {}),
        });
        const res = await fetch(`${ENDPOINTS.players}?${qs.toString()}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const payload = await res.json();
        const raw = Array.isArray(payload.players) ? payload.players : [];
        allPlayers = raw.map(normalizePlayer);
        $('connectionStatus').className = 'connection-status connected';
        $('connectionStatus').innerHTML = '<i class="fas fa-plug"></i><span>Connected to API</span>';
        displayPlayers(allPlayers);
        updatePlayerCount(Number(payload.total_players ?? allPlayers.length));
        createPositionChart(allPlayers);
      } else {
        allPlayers = [...samplePlayers];
        $('connectionStatus').className = 'connection-status disconnected';
        $('connectionStatus').innerHTML = '<i class="fas fa-plug"></i><span>Using Demo Data</span>';
        displayPlayers(allPlayers);
        updatePlayerCount(allPlayers.length);
        createPositionChart(allPlayers);
      }
      hideLoader('playersLoader','playersTable');
    } catch (error) {
      console.error('Error loading players:', error);
      allPlayers = [...samplePlayers];
      displayPlayers(allPlayers);
      updatePlayerCount(allPlayers.length);
      createPositionChart(allPlayers);
      showError('playersError','Failed to load player data. Using demo data instead.');
      hideLoader('playersLoader','playersTable');
    }
  }

  function loadScouts() {
    allScouts = [...dummyScouts];
    displayScouts(allScouts);
  }

  // =============================
  // FORM UX (bottom form)
  // =============================
  function resetForm(){
    $('playerForm').reset();
    $('playerId').value = '';
    $('formTitle').textContent = 'Add Player';
  }
  function populateForm(playerJson){
    const p = playerJson ? JSON.parse(playerJson) : null;
    if (!p) return;
    $('playerId').value = p.name || '';
    $('name').value = p.name || '';
    $('age').value = p.age ?? '';
    $('position').value = p.position || 'MID';
    $('rating').value = p.rating ?? '';
    $('club').value = p.club || '';
    $('nationality').value = p.nationality || 'ENG';
    $('notes').value = p.notes || '';
    $('formTitle').textContent = 'Edit Player';
    showSection('addEdit');
  }

  async function handlePlayerSubmit(e){
    e.preventDefault();
    const formData = {
      name: $('name').value.trim(),
      ...( $('age').value ? { age: Number($('age').value) } : {} ),
      position: $('position').value,
      ...( $('rating').value ? { rating: Number($('rating').value) } : {} ),
      club: $('club').value.trim(),
      nationality: $('nationality').value,
      ...( $('notes').value.trim() ? { notes: $('notes').value.trim() } : {} ),
    };
    const playerId = $('playerId').value; // original name when editing

    try {
      if (apiMode) {
        const isEdit = Boolean(playerId);
        const url = isEdit ? `${ENDPOINTS.players}/${encodeURIComponent(playerId)}` : ENDPOINTS.players;
        const method = isEdit ? 'PUT' : 'POST';
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData),
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err?.error || `HTTP ${res.status}`);
        }
        alert(`Player ${isEdit ? 'updated' : 'added'} (API mode)`);
        await loadPlayers();
      } else {
        if (playerId) {
          const idx = allPlayers.findIndex(p => p.name === playerId);
          if (idx !== -1) allPlayers[idx] = { ...allPlayers[idx], ...formData };
        } else {
          allPlayers.push(formData);
        }
        displayPlayers(allPlayers);
        updatePlayerCount(allPlayers.length);
        createPositionChart(allPlayers);
        alert(`Player ${playerId ? 'updated' : 'added'} (demo mode)`);
      }
    } catch (err) {
      alert(`Save failed: ${err.message}`);
    }
    resetForm();
    showSection('players');
  }

  async function deletePlayer(nameJson){
    const name = JSON.parse(nameJson);
    if (!confirm(`Delete ${name}?`)) return;
    try {
      if (apiMode) {
        const res = await fetch(`${ENDPOINTS.players}/${encodeURIComponent(name)}`, { method: 'DELETE' });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err?.error || `HTTP ${res.status}`);
        }
        await loadPlayers();
      } else {
        const idx = allPlayers.findIndex(p => p.name === name);
        if (idx !== -1) allPlayers.splice(idx,1);
        displayPlayers(allPlayers);
        updatePlayerCount(allPlayers.length);
        createPositionChart(allPlayers);
      }
    } catch (err) {
      alert(`Delete failed: ${err.message}`);
    }
  }

  // =============================
  // SEARCH & TOGGLE
  // =============================
  async function searchPlayers(query){
    currentSearch = (query || '').trim();
    if (apiMode) {
      currentPage = 1; // reset
      await loadPlayers();
    } else {
      if (!currentSearch) { 
        displayPlayers(allPlayers); 
        createPositionChart(allPlayers);
        return; 
      }
      const q = currentSearch.toLowerCase();
      const filtered = allPlayers.filter(p =>
        (p.name || '').toLowerCase().includes(q) ||
        (p.position || '').toLowerCase().includes(q) ||
        (p.club || '').toLowerCase().includes(q) ||
        (getNationalityName(p.nationality) || '').toLowerCase().includes(q)
      );
      displayPlayers(filtered);
      createPositionChart(filtered);
    }
  }

  function searchScouts(query){
    const q = (query || '').trim().toLowerCase();
    if (!q) {
      displayScouts(allScouts);
      return;
    }
    
    const filtered = allScouts.filter(s =>
      (s.name || '').toLowerCase().includes(q) ||
      (s.region || '').toLowerCase().includes(q) ||
      (s.experience || '').toLowerCase().includes(q) ||
      (s.status || '').toLowerCase().includes(q)
    );
    displayScouts(filtered);
  }

  function setToggleUI(on){
    const knob = document.getElementById('apiKnob');
    knob.style.transform = on ? 'translateX(20px)' : 'translateX(0)';
  }

  // =============================
  // EVENTS
  // =============================
  document.addEventListener('DOMContentLoaded', () => {
    // listeners
    $('playerForm').addEventListener('submit', handlePlayerSubmit);
    $('resetFormBtn').addEventListener('click', resetForm);
    $('cancelEditBtn').addEventListener('click', () => {
      resetForm();
      showSection('players');
    });
    $('addPlayerBtn').addEventListener('click', () => {
      resetForm();
      showSection('addEdit');
    });
    $('searchInput').addEventListener('input', (e) => searchPlayers(e.target.value));
    $('scoutSearchInput').addEventListener('input', (e) => searchScouts(e.target.value));
    $('apiToggle').addEventListener('change', async (e) => {
      apiMode = e.target.checked;
      setToggleUI(apiMode);
      await loadPlayers();
    });

    // Navigation click handlers
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = item.getAttribute('href').substring(1);
        showSection(targetId);
      });
    });

    // initial load in demo mode
    allPlayers = [...samplePlayers];
    displayPlayers(allPlayers);
    updatePlayerCount(allPlayers.length);
    createPositionChart(allPlayers);

    // Show the overview section by default
    showSection('overview');

    // Preload charts + API-driven widgets (does not switch to API mode)
    createActivityChart();
    initDashboard();
  });
  </script>
</body>
</html> can you make the reports functional to generate reports of players
