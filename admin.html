<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Football Admin Dashboard</title>
  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome (icons) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    .connection-status { 
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
    }
    .connected {
      background-color: #dcfce7;
      color: #166534;
    }
    .disconnected {
      background-color: #fef3c7;
      color: #92400e;
    }
    .error-banner {
      display: none;
      margin-top: 0.5rem;
      font-size: 0.875rem;
      color: #b91c1c;
      background-color: #fee2e2;
      border: 1px solid #fecaca;
      border-radius: 0.375rem;
      padding: 0.5rem;
    }
    .loader {
      display: none;
      font-size: 0.875rem;
      color: #6b7280;
    }
    .hidden-section {
      display: none;
    }
    .active-nav-item {
      background-color: #374151;
    }
    /* Analytics specific styles */
    .analytics-grid { 
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .analytics-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      border: 1px solid #e5e7eb;
    }
    .analytics-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #1e293b;
    }
    .stat-label {
      color: #64748b;
      font-size: 0.875rem;
    }
    .trend-positive {
      color: #10b981;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .trend-negative {
      color: #ef4444;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .progress-bar {
      height: 8px;
      background-color: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 8px;
    }
    .progress-fill {
      height: 100%;
      border-radius: 4px;
      background-color: #3b82f6;
    }
  </style>
</head>
<body class="min-h-screen bg-slate-50 flex">
  <!-- Sidebar -->
  <aside class="w-64 bg-slate-800 text-white min-h-screen p-4 hidden md:block">
    <h2 class="text-xl font-bold mb-6">Dashboard</h2>
    <nav class="space-y-2">
      <a href="#overview" class="nav-item block px-3 py-2 rounded hover:bg-slate-700"><i class="fa-solid fa-gauge mr-2"></i>Overview</a>
      <a href="#players" class="nav-item block px-3 py-2 rounded hover:bg-slate-700"><i class="fa-solid fa-users mr-2"></i>Players</a>
      <a href="#scouts" class="nav-item block px-3 py-2 rounded hover:bg-slate-700"><i class="fa-solid fa-user-secret mr-2"></i>Scouts</a>
      <a href="#clubs" class="nav-item block px-3 py-2 rounded hover:bg-slate-700"><i class="fa-solid fa-building mr-2"></i>Clubs</a>
      <a href="#reports" class="nav-item block px-3 py-2 rounded hover:bg-slate-700"><i class="fa-solid fa-clipboard-list mr-2"></i>Reports</a>
      <a href="#analytics" class="nav-item block px-3 py-2 rounded hover:bg-slate-700"><i class="fa-solid fa-chart-line mr-2"></i>Analytics</a>
      <a href="index" class="nav-item block px-3 py-2 rounded hover:bg-slate-700"><i class="fa-solid fa-plus mr-2"></i>Logout</a>
    </nav>
  </aside>

  <!-- Main content -->
  <div class="flex-1 flex flex-col">
    <!-- Top bar -->
    <header class="w-full bg-white border-b border-slate-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
        <h1 class="text-xl font-semibold text-slate-800">Admin Dashboard</h1>
        <div class="flex items-center gap-4">
          <!-- API Mode toggle -->
          <label class="inline-flex items-center cursor-pointer select-none">
            <input type="checkbox" id="apiToggle" class="sr-only" />
            <span class="mr-2 text-sm text-slate-600">API Mode</span>
            <span class="relative">
              <span class="block w-12 h-7 bg-slate-300 rounded-full shadow-inner"></span>
              <span id="apiKnob" class="absolute block w-6 h-6 bg-white rounded-full shadow -left-0.5 top-0.5 transition"></span>
            </span>
          </label>
          <div id="connectionStatus" class="connection-status disconnected">
            <i class="fas fa-plug"></i><span>Using Demo Data</span>
          </div>
        </div>
      </div>
    </header>

    <main class="flex-1 overflow-y-auto max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <!-- KPI Cards -->
      <section id="overview" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="bg-white rounded-2xl shadow p-4">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-slate-500">Players</p>
              <p class="text-3xl font-bold text-slate-800"><span id="playersCount">0</span></p>
            </div>
            <div class="text-sky-600 text-2xl"><i class="fa-solid fa-users"></i></div>
          </div>
        </div>
        <div class="bg-white rounded-2xl shadow p-4">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-slate-500">Reports</p>
              <p class="text-3xl font-bold text-slate-800"><span id="reportsCount">0</span></p>
            </div>
            <div class="text-emerald-600 text-2xl"><i class="fa-solid fa-clipboard-list"></i></div>
          </div>
        </div>
        <div class="bg-white rounded-2xl shadow p-4">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-slate-500">Clubs</p>
              <p class="text-3xl font-bold text-slate-800"><span id="clubsCount">0</span></p>
            </div>
            <div class="text-indigo-600 text-2xl"><i class="fa-solid fa-building"></i></div>
          </div>
        </div>
        <div class="bg-white rounded-2xl shadow p-4">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-slate-500">Scouts</p>
              <p class="text-3xl font-bold text-slate-800"><span id="scoutsCount">0</span></p>
            </div>
            <div class="text-rose-600 text-2xl"><i class="fa-solid fa-user-secret"></i></div>
          </div>
        </div>
      </section>

      <!-- Charts -->
      <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-6">
        <div class="bg-white rounded-2xl shadow p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-semibold text-slate-800">Positions Breakdown</h2>
          </div>
          <canvas id="positionsChart" height="140"></canvas>
        </div>
        <div class="bg-white rounded-2xl shadow p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-semibold text-slate-800">Weekly Activity</h2>
          </div>
          <canvas id="activityChart" height="140"></canvas>
        </div>
      </section>

      <!-- Player Management -->
      <section id="players" class="bg-white rounded-2xl shadow mt-6">
        <div class="p-4 border-b border-slate-200 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
          <h2 class="text-lg font-semibold text-slate-800">Player Management</h2>
          <div class="flex items-center gap-2">
            <div class="relative">
              <input id="searchInput" type="text" placeholder="Search players by name, position or club..." class="w-64 border border-slate-200 rounded-xl py-2 pl-9 pr-3 text-sm focus:ring-2 focus:ring-sky-400 focus:outline-none" />
              <i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-slate-400"></i>
            </div>
            <button id="addPlayerBtn" class="inline-flex items-center gap-2 bg-sky-600 text-white text-sm font-medium px-3 py-2 rounded-xl hover:bg-sky-700">
              <i class="fa-solid fa-plus"></i> New Player
            </button>
          </div>
        </div>

        <div id="playersError" class="error-banner mx-4">Failed to load player data. Using demo data instead.</div>

        <div class="p-4">
          <div id="playersLoader" class="loader">Loading players…</div>
          <div class="overflow-x-auto">
            <table id="playersTable" class="min-w-full text-sm">
              <thead>
                <tr class="text-left text-slate-600 border-b">
                  <th class="py-2 pr-4">Name</th>
                  <th class="py-2 pr-4">Age</th>
                  <th class="py-2 pr-4">Position</th>
                  <th class="py-2 pr-4">Rating</th>
                  <th class="py-2 pr-4">Club</th>
                  <th class="py-2 pr-4">Nationality</th>
                  <th class="py-2 pr-4">Actions</th>
                </tr>
              </thead>
              <tbody id="playersTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Scouts Section -->
      <section id="scouts" class="hidden-section bg-white rounded-2xl shadow mt-6">
        <div class="p-4 border-b border-slate-200 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
          <h2 class="text-lg font-semibold text-slate-800">Scout Management</h2>
          <div class="flex items-center gap-2">
            <div class="relative">
              <input id="scoutSearchInput" type="text" placeholder="Search scouts by name or region..." class="w-64 border border-slate-200 rounded-xl py-2 pl-9 pr-3 text-sm focus:ring-2 focus:ring-ssky-400 focus:outline-none" />
              <i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-slate-400"></i>
            </div>
            <button id="addScoutBtn" class="inline-flex items-center gap-2 bg-sky-600 text-white text-sm font-medium px-3 py-2 rounded-xl hover:bg-sky-700">
              <i class="fa-solid fa-plus"></i> New Scout
            </button>
          </div>
        </div>

        <div id="scoutsError" class="error-banner mx-4">Failed to load scout data. Using demo data instead.</div>

        <div class="p-4">
          <div id="scoutsLoader" class="loader">Loading scouts…</div>
          <div class="overflow-x-auto">
            <table id="scoutsTable" class="min-w-full text-sm">
              <thead>
                <tr class="text-left text-slate-600 border-b">
                  <th class="py-2 pr-4">Name</th>
                  <th class="py-2 pr-4">Region</th>
                  <th class="py-2 pr-4">Experience</th>
                  <th class="py-2 pr-4">Status</th>
                  <th class="py-2 pr-4">Actions</th>
                </tr>
              </thead>
              <tbody id="scoutsTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Clubs Section -->
      <section id="clubs" class="hidden-section bg-white rounded-2xl shadow mt-6">
        <div class="p-4 border-b border-slate-200 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
          <h2 class="text-lg font-semibold text-slate-800">Club Management</h2>
          <div class="flex items-center gap-2">
            <div class="relative">
              <input id="clubSearchInput" type="text" placeholder="Search clubs by name or country..." class="w-64 border border-slate-200 rounded-xl py-2 pl-9 pr-3 text-sm focus:ring-2 focus:ring-sky-400 focus:outline-none" />
              <i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-slate-400"></i>
            </div>
            <button id="addClubBtn" class="inline-flex items-center gap-2 bg-sky-600 text-white text-sm font-medium px-3 py-2 rounded-xl hover:bg-sky-700">
              <i class="fa-solid fa-plus"></i> New Club
            </button>
          </div>
        </div>

        <div id="clubsError" class="error-banner mx-4">Failed to load club data. Using demo data instead.</div>

        <div class="p-4">
          <div id="clubsLoader" class="loader">Loading clubs…</div>
          <div class="overflow-x-auto">
            <table id="clubsTable" class="min-w-full text-sm">
              <thead>
                <tr class="text-left text-slate-600 border-b">
                  <th class="py-2 pr-4">Name</th>
                  <th class="py-2 pr-4">Country</th>
                  <th class="py-2 pr-4">League</th>
                  <th class="py-2 pr-4">Stadium</th>
                  <th class="py-2 pr-4">Founded</th>
                  <th class="py-2 pr-4">Actions</th>
                </tr>
              </thead>
              <tbody id="clubsTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Analytics Section -->
      <section id="analytics" class="hidden-section bg-white rounded-2xl shadow mt-6">
        <div class="p-4 border-b border-slate-200">
          <h2 class="text-lg font-semibold text-slate-800">Football Analytics Dashboard</h2>
          <p class="text-sm text-slate-600">Performance metrics and insights from your football data</p>
        </div>
        
        <div class="p-4">
          <div id="analyticsError" class="error-banner">Failed to load analytics data. Using demo data instead.</div>
          <div id="analyticsLoader" class="loader">Loading analytics data…</div>
          
          <div class="analytics-grid">
            <!-- Player Performance Stats -->
            <div class="analytics-card">
              <div class="analytics-header">
                <h3 class="text-md font-semibold">Player Performance</h3>
                <i class="fa-solid fa-users text-sky-600"></i>
              </div>
              <div class="stat-value" id="avgPlayerRating">0.0</div>
              <div class="stat-label">Average Player Rating</div>
              <div class="trend-positive" id="ratingTrend">
                <i class="fa-solid fa-arrow-up"></i>
                <span>2.5% from last month</span>
              </div>
            </div>
            
            <!-- Top Scorers -->
            <div class="analytics-card">
              <div class="analytics-header">
                <h3 class="text-md font-semibold">Top Scorers</h3>
                <i class="fa-solid fa-futbol text-emerald-600"></i>
              </div>
              <div id="topScorersList">
                <!-- Will be populated by JavaScript -->
              </div>
            </div>
            
            <!-- Position Distribution -->
            <div class="analytics-card">
              <div class="analytics-header">
                <h3 class="text-md font-semibold">Position Distribution</h3>
                <i class="fa-solid fa-chart-pie text-indigo-600"></i>
              </div>
              <canvas id="positionDistributionChart" height="150"></canvas>
            </div>
            
            <!-- Age Distribution -->
            <div class="analytics-card">
              <div class="analytics-header">
                <h3 class="text-md font-semibold">Age Groups</h3>
                <i class="fa-solid fa-user-clock text-rose-600"></i>
              </div>
              <canvas id="ageDistributionChart" height="150"></canvas>
            </div>
            
            <!-- Performance by Nationality -->
            <div class="analytics-card">
              <div class="analytics-header">
                <h3 class="text-md font-semibold">Top Nationalities</h3>
                <i class="fa-solid fa-globe text-amber-600"></i>
              </div>
              <div id="nationalityStats">
                <!-- Will be populated by JavaScript -->
              </div>
            </div>
            
            <!-- Recent Activity -->
            <div class="analytics-card">
              <div class="analytics-header">
                <h3 class="text-md font-semibold">Recent Activity</h3>
                <i class="fa-solid fa-bell text-purple-600"></i>
              </div>
              <div id="recentActivity">
                <!-- Will be populated by JavaScript -->
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Add/Edit Player Form -->
      <section id="addEdit" class="bg-white rounded-2xl shadow mt-6 p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 id="formTitle" class="text-lg font-semibold text-slate-800">Add Player</h3>
          <button id="resetFormBtn" class="text-sm text-slate-600 hover:text-slate-800"><i class="fa-solid fa-rotate-left mr-1"></i>Reset</button>
        </div>
        <form id="playerForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="hidden" id="playerId" />
          <div>
            <label class="block text-sm text-slate-600 mb-1">Name</label>
            <input id="name" class="w-full border border-slate-200 rounded-xl px-3 py-2" required />
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">Age</label>
            <input id="age" type="number" min="18" max="45" class="wfull border border-slate-200 rounded-xl px-3 py-2" />
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">Position</label>
            <select id="position" class="w-full border border-slate-200 rounded-xl px-3 py-2">
              <option>GK</option>
              <option>DEF</option>
              <option>MID</option>
              <option>FWD</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">Rating</label>
            <input id="rating" type="number" step="0.1" min="0" max="10" class="w-full border border-slate-200 rounded-xl px-3 py-2" />
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">Club</label>
            <input id="club" class="w-full border border-slate-200 rounded-xl px-3 py-2" />
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">Nationality</label>
            <select id="nationality" class="w-full border border-slate-200 rounded-xl px-3 py-2">
              <option value="ARG">Argentina</option>
              <option value="BRA">Brazil</option>
              <option value="ENG">England</option>
              <option value="FRA">France</option>
              <option value="GER">Germany</option>
              <option value="ITA">Italy</option>
              <option value="NED">Netherlands</option>
              <option value="POR">Portugal</option>
              <option value="ESP">Spain</option>
              <option value="URU">Uruguay</option>
            </select>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm text-slate-600 mb-1">Notes</label>
            <textarea id="notes" rows="3" class="w-full border border-slate-200 rounded-xl px-3 py-2"></textarea>
          </div>
          <div class="md:col-span-2 flex justify-end gap-2 mt-2">
            <button type="button" id="cancelEditBtn" class="px-4 py-2 rounded-xl border border-slate-200">Cancel</button>
            <button type="submit" class="px-4 py-2 rounded-xl bg-sky-600 text-white">Save</button>
          </div>
        </form>
      </section>

      <!-- Add Scout Modal -->
      <div id="addScoutModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md">
          <h3 class="text-lg font-semibold text-slate-800 mb-4" id="scoutModalTitle">Add New Scout</h3>
          <form id="scoutForm">
            <input type="hidden" id="scoutId" />
            <div class="mb-4">
              <label class="block text-sm text-slate-600 mb-1">Name</label>
              <input type="text" id="scoutName" class="w-full border border-slate-200 rounded-xl px-3 py-2" required />
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-600 mb-1">Region</label>
              <input type="text" id="scoutRegion" class="w-full border border-slate-200 rounded-xl px-3 py-2" required />
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-600 mb-1">Experience (years)</label>
              <input type="number" id="scoutExperience" min="1" max="50" class="w-full border border-slate-200 rounded-xl px-3 py-2" />
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-600 mb-1">Status</label>
              <select id="scoutStatus" class="w-full border border-slate-200 rounded-xl px-3 py-2">
                <option value="Active">Active</option>
                <option value="On Leave">On Leave</option>
                <option value="Training">Training</option>
              </select>
            </div>
            <div class="flex justify-end gap-2">
              <button type="button" id="cancelScoutBtn" class="px-4 py-2 rounded-xl border border-slate-200">Cancel</button>
              <button type="submit" class="px-4 py-2 rounded-xl bg-sky-600 text-white">Save</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Add Club Modal -->
      <div id="addClubModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md">
          <h3 class="text-lg font-semibold text-slate-800 mb-4" id="clubModalTitle">Add New Club</h3>
          <form id="clubForm">
            <input type="hidden" id="clubId" />
            <div class="mb-4">
              <label class="block text-sm text-slate-600 mb-1">Name</label>
              <input type="text" id="clubName" class="w-full border border-slate-200 rounded-xl px-3 py-2" required />
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-600 mb-1">Country</label>
              <input type="text" id="clubCountry" class="w-full border border-slate-200 rounded-xl px-3 py-2" required />
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-600 mb-1">League</label>
              <input type="text" id="clubLeague" class="w-full border border-slate-200 rounded-xl px-3 py-2" required />
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-600 mb-1">Stadium</label>
              <input type="text" id="clubStadium" class="w-full border border-slate-200 rounded-xl px-3 py-2" />
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-600 mb-1">Founded Year</label>
              <input type="number" id="clubFounded" min="1800" max="2023" class="w-full border border-slate-200 rounded-xl px-3 py-2" />
            </div>
            <div class="flex justify-end gap-2">
              <button type="button" id="cancelClubBtn" class="px-4 py-2 rounded-xl border border-slate-200">Cancel</button>
              <button type="submit" class="px-4 py-2 rounded-xl bg-sky-600 text-white">Save</button>
            </div>
          </form>
        </div>
      </div>
    </main>
  </div>

  <script>
  // =============================
  // API CONFIG
  // =============================
  const API_BASE = "https://players-flask-app.onrender.com";
  const ENDPOINTS = {
    players: `${API_BASE}/players`,
    playerReports: `${API_BASE}/player-reports`,
    scouts: `${API_BASE}/scouts`,
    clubs: `${API_BASE}/clubs`,
    analytics: `${API_BASE}/analytics`,
  };

  // =============================
  // STATE
  // =============================
  let apiMode = false;
  let allPlayers = [];
  let allScouts = [];
  let allClubs = [];
  let currentPage = 1;
  let currentLimit = 50;
  let currentSearch = "";
  let activeSection = "overview";
  let analyticsCharts = {};

  // Demo data fallback
  const samplePlayers = [
    { name: "John Smith", age: 22, position: "MID", rating: 7.4, club: "City FC", nationality: "ENG" },
    { name: "Pedro Alvarez", age: 25, position: "FWD", rating: 8.1, club: "United SC", nationality: "ESP" },
    { name: "Sizwe Mokoena", age: 21, position: "DEF", rating: 7.2, club: "Soweto Stars", nationality: "RSA" },
    { name: "Marco Rossi", age: 28, position: "GK",  rating: 7.8, club: "Milano AC", nationality: "ITA" },
    { name: "Lionel Messi", age: 35, position: "FWD", rating: 9.5, club: "Inter Miami", nationality: "ARG" },
    { name: "Cristiano Ronaldo", age: 37, position: "FWD", rating: 9.2, club: "Al Nassr", nationality: "POR" },
    { name: "Kylian Mbappé", age: 24, position: "FWD", rating: 9.0, club: "PSG", nationality: "FRA" },
    { name: "Kevin De Bruyne", age: 31, position: "MID", rating: 8.9, club: "Manchester City", nationality: "BEL" },
    { name: "Virgil van Dijk", age: 31, position: "DEF", rating: 8.7, club: "Liverpool", nationality: "NED" },
    { name: "Manuel Neuer", age: 36, position: "GK", rating: 8.6, club: "Bayern Munich", nationality: "GER" },
  ];

  // Dummy scouts data for demo mode
  const dummyScouts = [
    { name: "James Wilson", region: "Europe", experience: 15, status: "Active" },
    { name: "Maria Rodriguez", region: "South America", experience: 8, status: "Active" },
    { name: "David Chen", region: "Asia", experience: 3, status: "Training" },
    { name: "Sarah Johnson", region: "North America", experience: 12, status: "Active" },
    { name: "Ahmed Hassan", region: "Africa", experience: 7, status: "On Leave" }
  ];

  // Dummy clubs data for demo mode
  const dummyClubs = [
    { name: "Manchester United", country: "England", league: "Premier League", stadium: "Old Trafford", founded: 1878 },
    { name: "Real Madrid", country: "Spain", league: "La Liga", stadium: "Santiago Bernabéu", founded: 1902 },
    { name: "Bayern Munich", country: "Germany", league: "Bundesliga", stadium: "Allianz Arena", founded: 1900 },
    { name: "Juventus", country: "Italy", league: "Serie A", stadium: "Allianz Stadium", founded: 1897 },
    { name: "Paris Saint-Germain", country: "France", league: "Ligue 1", stadium: "Parc des Princes", founded: 1970 }
  ];

  // Available positions
  const positions = ["GK", "DEF", "MID", "FWD"];

  // Available nationalities with country codes and names
  const nationalities = [
    { code: "ARG", name: "Argentina" },
    { code: "BEL", name: "Belgium" },
    { code: "BRA", name: "Brazil" },
    { code: "COL", name: "Colombia" },
    { code: "CRO", name: "Croatia" },
    { code: "ENG", name: "England" },
    { code: "FRA", name: "France" },
    { code: "GER", name: "Germany" },
    { code: "ITA", name: "Italy" },
    { code: "NED", name: "Netherlands" },
    { code: "POR", name: "Portugal" },
    { code: "ESP", name: "Spain" },
    { code: "URU", name: "Uruguay" },
    { code: "USA", name: "United States" },
    { code: "RSA", name: "South Africa" },
    { code: "EGY", name: "Egypt" },
    { code: "NGA", name: "Nigeria" },
    { code: "JPN", name: "Japan" },
    { code: "KOR", name: "South Korea" },
    { code: "MEX", name: "Mexico" }
  ];

  // =============================
  // NORMALIZER
  // =============================
  function normalizePlayer(p){
    let age = Math.floor(Math.random() * (45 - 18 + 1)) + 18;
    let position = positions[Math.floor(Math.random() * positions.length)];
    let nationality = nationalities[Math.floor(Math.random() * nationalities.length)].code;

    let rating = p.rating ?? p.Rating ?? p["Original Rating"] ?? p["Alternative Rating"];
    if (rating !== undefined && rating !== null && rating !== '') {
      const n = Number(rating);
      rating = isNaN(n) ? rating : n;
    }

    return {
      name: p.name || p.Name || 'N/A',
      age,
      position,
      rating: rating ?? 'N/A',
      club: p.club || p["Team Name"] || p.Team || 'N/A',
      nationality,
      notes: p.notes || p.Notes || ''
    };
  }

  // Helper function to get nationality name from code
  function getNationalityName(code) {
    const nationality = nationalities.find(n => n.code === code);
    return nationality ? nationality.name : code;
  }

  // =============================
  // HELPERS
  // =============================
  function $(id){ return document.getElementById(id); }

  function animateValue(el, start, end, duration) {
    const s = Number(start)||0, e = Number(end)||0, range = e - s;
    if (!range) { el.textContent = String(e); return; }
    const t0 = performance.now();
    function tick(t){
      const k = Math.min((t - t0) / duration, 1);
      el.textContent = String(Math.floor(s + range * k));
      if (k < 1) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  }

  function showLoader(loaderId, tableId){
    $(loaderId).style.display = 'block';
    if (tableId) $(tableId).classList.add('opacity-50');
  }
  function hideLoader(loaderId, tableId){
    $(loaderId).style.display = 'none';
    if (tableId) $(tableId).classList.remove('opacity-50');
  }
  function showError(id, msg){ const el=$(id); el.textContent=msg; el.style.display='block'; }
  function hideError(id){ $(id).style.display='none'; }

  function updatePlayerCount(n){
    const el = $('playersCount');
    animateValue(el, Number(el.textContent)||0, n, 800);
  }

  function updateScoutCount(n){
    const el = $('scoutsCount');
    animateValue(el, Number(el.textContent)||0, n, 800);
  }

  function updateClubCount(n){
    const el = $('clubsCount');
    animateValue(el, Number(el.textContent)||0, n, 800);
  }

  function displayPlayers(list){
    const tbody = $('playersTbody');
    tbody.innerHTML = '';
    list.forEach(p => {
      const tr = document.createElement('tr');
      tr.className = 'border-b hover:bg-slate-50';
      tr.innerHTML = `
        <td class="py-2 pr-4 font-medium text-slate-800">${p.name ?? 'N/A'}</td>
        <td class="py-2 pr-4">${p.age ?? '—'}</td>
        <td class="py-2 pr-4">${p.position ?? '—'}</td>
        <td class="py-2 pr-4">${p.rating ?? '—'}</td>
        <td class="py-2 pr-4">${p.club ?? '—'}</td>
        <td class="py-2 pr-4">${getNationalityName(p.nationality) ?? '—'}</td>
        <td class="py-2 pr-4">
          <button class="text-sky-600 hover:underline mr-2" onclick='populateForm(${JSON.stringify(JSON.stringify(p))})'>Edit</button>
          <button class="text-rose-600 hover:underline" onclick='deletePlayer(${JSON.stringify(JSON.stringify(p.name))})'>Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  function displayScouts(list){
    const tbody = $('scoutsTbody');
    tbody.innerHTML = '';
    list.forEach(s => {
      const tr = document.createElement('tr');
      tr.className = 'border-b hover:bg-slate-50';
      
      let statusColor = 'text-gray-600';
      if (s.status === 'Active') statusColor = 'text-green-600';
      if (s.status === 'On Leave') statusColor = 'text-yellow-600';
      if (s.status === 'Training') statusColor = 'text-blue-600';
      
      tr.innerHTML = `
        <td class="py-2 pr-4 font-medium text-slate-800">${s.name ?? 'N/A'}</td>
        <td class="py-2 pr-4">${s.region ?? '—'}</td>
        <td class="py-2 pr-4">${s.experience ?? '—'} years</td>
        <td class="py-2 pr-4 ${statusColor}">${s.status ?? '—'}</td>
        <td class="py-2 pr-4">
          <button class="text-sky-600 hover:underline mr-2" onclick='editScout(${JSON.stringify(JSON.stringify(s))})'>Edit</button>
          <button class="text-rose-600 hover:underline" onclick='deleteScout(${JSON.stringify(JSON.stringify(s.name))})'>Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  function displayClubs(list){
    const tbody = $('clubsTbody');
    tbody.innerHTML = '';
    list.forEach(c => {
      const tr = document.createElement('tr');
      tr.className = 'border-b hover:bg-slate-50';
      
      tr.innerHTML = `
        <td class="py-2 pr-4 font-medium text-slate-800">${c.name ?? 'N/A'}</td>
        <td class="py-2 pr-4">${c.country ?? '—'}</td>
        <td class="py-2 pr-4">${c.league ?? '—'}</td>
        <td class="py-2 pr-4">${c.stadium ?? '—'}</td>
        <td class="py-2 pr-4">${c.founded ?? '—'}</td>
        <td class="py-2 pr-4">
          <button class="text-sky-600 hover:underline mr-2" onclick='editClub(${JSON.stringify(JSON.stringify(c))})'>Edit</button>
          <button class="text-rose-600 hover:underline" onclick='deleteClub(${JSON.stringify(JSON.stringify(c.name))})'>Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  // Calculate position counts for the chart
  function calculatePositionCounts(players) {
    const counts = {
      "GK": 0,
      "DEF": 0,
      "MID": 0,
      "FWD": 0
    };
    
    players.forEach(player => {
      if (player.position && counts.hasOwnProperty(player.position)) {
        counts[player.position]++;
      }
    });
    
    return counts;
  }

  // charts
  let positionsChart, activityChart;
  function createPositionChart(players){
    const ctx = document.getElementById('positionsChart');
    const positionCounts = calculatePositionCounts(players);
    const labels = Object.keys(positionCounts);
    const values = Object.values(positionCounts);
    
    const backgroundColors = [
      'rgba(255, 99, 132, 0.7)',
      'rgba(54, 162, 235, 0.7)',
      'rgba(255, 206, 86, 0.7)',
      'rgba(75, 192, 192, 0.7)'
    ];
    
    if (positionsChart) positionsChart.destroy();
    positionsChart = new Chart(ctx, {
      type: 'doughnut',
      data: { 
        labels, 
        datasets: [{ 
          data: values,
          backgroundColor: backgroundColors,
          borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
          borderWidth: 1
        }] 
      },
      options: { 
        responsive: true, 
        plugins: { 
          legend: { 
            position: 'bottom' 
          } 
        } 
      }
    });
  }
  
  function createActivityChart(){
    const ctx = document.getElementById('activityChart');
    const labels = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    const values = labels.map(() => Math.floor(Math.random()*20)+5);
    if (activityChart) activityChart.destroy();
    activityChart = new Chart(ctx, {
      type: 'line',
      data: { 
        labels, 
        datasets: [{ 
          label: 'Events', 
          data: values, 
          tension: 0.35, 
          fill: true,
          backgroundColor: 'rgba(54, 162, 235, 0.2)',
      borderColor: 'rgba(54, 162, 235, 1)',
      borderWidth: 2,
      pointBackgroundColor: 'rgba(54, 162, 235, 1)'
        }] 
      },
      options: { 
        responsive: true, 
        plugins: { 
          legend: { 
            display: false 
          } 
        } 
      }
    });
  }

  // =============================
  // SCOUT MANAGEMENT FUNCTIONS
  // =============================
  // =============================
// SCOUT MANAGEMENT FUNCTIONS (FIXED)
// =============================
async function loadScouts() {
  try {
    showLoader('scoutsLoader', 'scoutsTable');
    hideError('scoutsError');
    
    if (apiMode) {
      const res = await fetch(ENDPOINTS.scouts);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      allScouts = await res.json();
      
      // Update connection status
      $('connectionStatus').className = 'connection-status connected';
      $('connectionStatus').innerHTML = '<i class="fas fa-plug"></i><span>Connected to API</span>';
    } else {
      // Use demo data
      $('connectionStatus').className = 'connection-status disconnected';
      $('connectionStatus').innerHTML = '<i class="fas fa-plug"></i><span>Using Demo Data</span>';
      allScouts = [...dummyScouts];
    }
    
    displayScouts(allScouts);
    updateScoutCount(allScouts.length);
    hideLoader('scoutsLoader', 'scoutsTable');
  } catch (error) {
    console.error('Error loading scouts:', error);
    // Fallback to demo data
    allScouts = [...dummyScouts];
    displayScouts(allScouts);
    updateScoutCount(allScouts.length);
    showError('scoutsError', 'Failed to load scout data. Using demo data instead.');
    hideLoader('scoutsLoader', 'scoutsTable');
  }
}

async function addScout(scoutData) {
  try {
    if (apiMode) {
      const res = await fetch(ENDPOINTS.scouts, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(scoutData)
      });
      
      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.error || 'Failed to add scout');
      }
      
      await loadScouts();
      alert('Scout added successfully!');
    } else {
      // Demo mode
      allScouts.push(scoutData);
      displayScouts(allScouts);
      updateScoutCount(allScouts.length);
      alert('Scout added successfully! (Demo mode)');
    }
  } catch (error) {
    alert(`Error adding scout: ${error.message}`);
  }
}

async function updateScout(scoutName, scoutData) {
  try {
    if (apiMode) {
      const res = await fetch(`${ENDPOINTS.scouts}/${encodeURIComponent(scoutName)}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(scoutData)
      });
      
      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.error || 'Failed to update scout');
      }
      
      await loadScouts();
      alert('Scout updated successfully!');
    } else {
      // Demo mode
      const index = allScouts.findIndex(s => s.name === scoutName);
      if (index !== -1) {
        allScouts[index] = { ...allScouts[index], ...scoutData };
        displayScouts(allScouts);
        alert('Scout updated successfully! (Demo mode)');
      }
    }
  } catch (error) {
    alert(`Error updating scout: ${error.message}`);
  }
}

async function deleteScout(scoutName) {
  if (!confirm(`Are you sure you want to delete ${scoutName}?`)) return;
  
  try {
    if (apiMode) {
      const res = await fetch(`${ENDPOINTS.scouts}/${encodeURIComponent(scoutName)}`, {
        method: 'DELETE'
      });
      
      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.error || 'Failed to delete scout');
      }
      
      await loadScouts();
      alert('Scout deleted successfully!');
    } else {
      // Demo mode
      allScouts = allScouts.filter(s => s.name !== scoutName);
      displayScouts(allScouts);
      updateScoutCount(allScouts.length);
      alert('Scout deleted successfully! (Demo mode)');
    }
  } catch (error) {
    alert(`Error deleting scout: ${error.message}`);
  }
}

function editScout(scoutJson) {
  const scout = JSON.parse(scoutJson);
  
  // Populate form fields
  $('#scoutName').value = scout.name || '';
  $('#scoutRegion').value = scout.region || '';
  $('#scoutExperience').value = scout.experience || '';
  $('#scoutStatus').value = scout.status || 'Active';
  
  // Update modal title
  $('#scoutModalTitle').textContent = 'Edit Scout';
  
  // Show modal
  $('#addScoutModal').classList.remove('hidden');
  
  // Update form submit handler
  $('#scoutForm').onsubmit = async function(e) {
    e.preventDefault();
    
    const scoutData = {
      name: $('#scoutName').value,
      region: $('#scoutRegion').value,
      experience: parseInt($('#scoutExperience').value) || 1,
      status: $('#scoutStatus').value
    };
    
    await updateScout(scout.name, scoutData);
    $('#addScoutModal').classList.add('hidden');
  };
}

// =============================
// EVENT LISTENERS (FIXED)
// =============================
function initScoutEventListeners() {
  // Add scout button
  $('addScoutBtn').addEventListener('click', () => {
    $('#scoutForm').reset();
    $('#scoutModalTitle').textContent = 'Add New Scout';
    
    $('#scoutForm').onsubmit = async function(e) {
      e.preventDefault();
      const scoutData = {
        name: $('#scoutName').value,
        region: $('#scoutRegion').value,
        experience: parseInt($('#scoutExperience').value) || 1,
        status: $('#scoutStatus').value
      };
      await addScout(scoutData);
      $('#addScoutModal').classList.add('hidden');
    };
    
    $('#addScoutModal').classList.remove('hidden');
  });

  // Cancel scout button
  $('cancelScoutBtn').addEventListener('click', () => {
    $('#addScoutModal').classList.add('hidden');
  });

  // Scout search
  $('scoutSearchInput').addEventListener('input', (e) => {
    searchScouts(e.target.value);
  });
}

// Initialize event listeners when DOM is loaded
document.addEventListener('DOMContentLoaded', initScoutEventListeners);

  // =============================
  // CLUB MANAGEMENT FUNCTIONS
  // =============================
  async function loadClubs() {
    try {
      showLoader('clubsLoader', 'clubsTable');
      hideError('clubsError');
      
      if (apiMode) {
        const res = await fetch(ENDPOINTS.clubs);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        allClubs = await res.json();
        
        $('connectionStatus').className = 'connection-status connected';
        $('connectionStatus').innerHTML = '<i class="fas fa-plug"></i><span>Connected to API</span>';
      } else {
        $('connectionStatus').className = 'connection-status disconnected';
        $('connectionStatus').innerHTML = '<i class="fas fa-plug"></i><span>Using Demo Data</span>';
        allClubs = [...dummyClubs];
      }
      
      displayClubs(allClubs);
      updateClubCount(allClubs.length);
      hideLoader('clubsLoader', 'clubsTable');
    } catch (error) {
      console.error('Error loading clubs:', error);
      allClubs = [...dummyClubs];
      displayClubs(allClubs);
      updateClubCount(allClubs.length);
      showError('clubsError', 'Failed to load club data. Using demo data instead.');
      hideLoader('clubsLoader', 'clubsTable');
    }
  }

  async function addClub(clubData) {
    try {
      if (apiMode) {
        const res = await fetch(ENDPOINTS.clubs, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(clubData)
        });
        
        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || 'Failed to add club');
        }
        
        await loadClubs();
        alert('Club added successfully!');
      } else {
        allClubs.push(clubData);
        displayClubs(allClubs);
        updateClubCount(allClubs.length);
        alert('Club added successfully! (Demo mode)');
      }
    } catch (error) {
      alert(`Error adding club: ${error.message}`);
    }
  }

  async function updateClub(clubName, clubData) {
    try {
      if (apiMode) {
        const res = await fetch(`${ENDPOINTS.clubs}/${encodeURIComponent(clubName)}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(clubData)
        });
        
        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || 'Failed to update club');
        }
        
        await loadClubs();
        alert('Club updated successfully!');
      } else {
        const index = allClubs.findIndex(c => c.name === clubName);
        if (index !== -1) {
          allClubs[index] = { ...allClubs[index], ...clubData };
          displayClubs(allClubs);
          alert('Club updated successfully! (Demo mode)');
        }
      }
    } catch (error) {
      alert(`Error updating club: ${error.message}`);
    }
  }

  async function deleteClub(clubName) {
    if (!confirm(`Are you sure you want to delete ${clubName}?`)) return;
    
    try {
      if (apiMode) {
        const res = await fetch(`${ENDPOINTS.clubs}/${encodeURIComponent(clubName)}`, {
          method: 'DELETE'
        });
        
        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || 'Failed to delete club');
        }
        
        await loadClubs();
        alert('Club deleted successfully!');
      } else {
        allClubs = allClubs.filter(c => c.name !== clubName);
        displayClubs(allClubs);
        updateClubCount(allClubs.length);
        alert('Club deleted successfully! (Demo mode)');
      }
    } catch (error) {
      alert(`Error deleting club: {error.message}`);
    }
  }

  function editClub(clubJson) {
    const club = JSON.parse(clubJson);
    
    $('#clubName').value = club.name;
    $('#clubCountry').value = club.country;
    $('#clubLeague').value = club.league;
    $('#clubStadium').value = club.stadium || '';
    $('#clubFounded').value = club.founded || '';
    
    $('#clubModalTitle').textContent = 'Edit Club';
    $('#addClubModal').classList.remove('hidden');
    
    $('#clubForm').onsubmit = async function(e) {
      e.preventDefault();
      
      const clubData = {
        name: $('#clubName').value,
        country: $('#clubCountry').value,
        league: $('#clubLeague').value,
        stadium: $('#clubStadium').value,
        founded: parseInt($('#clubFounded').value) || 1900
      };
      
      await updateClub(club.name, clubData);
      $('#addClubModal').classList.add('hidden');
    };
  }

  // =============================
  // SECTION NAVIGATION
  // =============================
  function showSection(sectionId) {
    document.querySelectorAll('main > section').forEach(section => {
      section.classList.add('hidden-section');
    });
    
    const targetSection = $(sectionId);
    if (targetSection) {
      targetSection.classList.remove('hidden-section');
    }
    
    document.querySelectorAll('.nav-item').forEach(item => {
      item.classList.remove('active-nav-item');
    });
    
    const activeNavItem = document.querySelector(`.nav-item[href="#${sectionId}"]`);
    if (activeNavItem) {
      activeNavItem.classList.add('active-nav-item');
    }
    
    activeSection = sectionId;
    
    if (sectionId === 'scouts') {
      loadScouts();
    } else if (sectionId === 'clubs') {
      loadClubs();
    } else if (sectionId === 'analytics') {
      loadAnalytics();
    }
  }

  // =============================
  // CORE LOADERS
  // =============================
  async function initDashboard(){
    try {
      const resPlayers = await fetch(`${ENDPOINTS.players}?page=1&limit=50`);
      const playersPayload = await resPlayers.json();
      const total = Number(playersPayload?.total_players ?? 0);
      $('playersCount').textContent = total;
      animateValue($('playersCount'), 0, total, 1000);

      $('reportsCount').textContent = String(Math.floor(Math.random()*10)+5);
      $('clubsCount').textContent = String(allClubs.length);
      $('scoutsCount').textContent = String(allScouts.length);

      animateValue($('reportsCount'), 0, Number($('reportsCount').textContent), 1000);
      animateValue($('clubsCount'),   0, Number($('clubsCount').textContent),   1000);
      animateValue($('scoutsCount'),  0, Number($('scoutsCount').textContent),  1000);

      await loadPlayers();
      await loadScouts();
      await loadClubs();
    } catch (err) {
      console.error('❌ Error loading dashboard:', err);
      allPlayers = [...samplePlayers];
      allScouts = [...dummyScouts];
      allClubs = [...dummyClubs];
      displayPlayers(allPlayers);
      displayScouts(allScouts);
      displayClubs(allClubs);
      updatePlayerCount(allPlayers.length);
      updateScoutCount(allScouts.length);
      updateClubCount(allClubs.length);
      createPositionChart(allPlayers);
    }
  }

  async function loadPlayers(){
    try {
      showLoader('playersLoader','playersTable');
      hideError('playersError');

      if (apiMode) {
        const qs = new URLSearchParams({
          page: String(currentPage),
          limit: String(currentLimit),
          ...(currentSearch ? { name: currentSearch } : {}),
        });
        const res = await fetch(`${ENDPOINTS.players}?${qs.toString()}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const payload = await res.json();
        const raw = Array.isArray(payload.players) ? payload.players : [];
        allPlayers = raw.map(normalizePlayer);
        $('connectionStatus').className = 'connection-status connected';
        $('connectionStatus').innerHTML = '<i class="fas fa-plug"></i><span>Connected to API</span>';
        displayPlayers(allPlayers);
        updatePlayerCount(Number(payload.total_players ?? allPlayers.length));
        createPositionChart(allPlayers);
      } else {
        allPlayers = [...samplePlayers];
        $('connectionStatus').className = 'connection-status disconnected';
        $('connectionStatus').innerHTML = '<i class="fas fa-plug"></i><span>Using Demo Data</span>';
        displayPlayers(allPlayers);
        updatePlayerCount(allPlayers.length);
        createPositionChart(allPlayers);
      }
      hideLoader('playersLoader','playersTable');
    } catch (error) {
      console.error('Error loading players:', error);
      allPlayers = [...samplePlayers];
      displayPlayers(allPlayers);
      updatePlayerCount(allPlayers.length);
      createPositionChart(allPlayers);
      showError('playersError','Failed to load player data. Using demo data instead.');
      hideLoader('playersLoader','playersTable');
    }
  }

  // =============================
  // FORM UX
  // =============================
  function resetForm(){
    $('playerForm').reset();
    $('playerId').value = '';
    $('formTitle').textContent = 'Add Player';
  }
  function populateForm(playerJson){
    const p = playerJson ? JSON.parse(playerJson) : null;
    if (!p) return;
    $('playerId').value = p.name || '';
    $('name').value = p.name || '';
    $('age').value = p.age ?? '';
    $('position').value = p.position || 'MID';
    $('rating').value = p.rating ?? '';
    $('club').value = p.club || '';
    $('nationality').value = p.nationality || 'ENG';
    $('notes').value = p.notes || '';
    $('formTitle').textContent = 'Edit Player';
    showSection('addEdit');
  }

  async function handlePlayerSubmit(e){
    e.preventDefault();
    const formData = {
      name: $('name').value.trim(),
      ...( $('age').value ? { age: Number($('age').value) } : {} ),
      position: $('position').value,
      ...( $('rating').value ? { rating: Number($('rating').value) } : {} ),
      club: $('club').value.trim(),
      nationality: $('nationality').value,
      ...( $('notes').value.trim() ? { notes: $('notes').value.trim() } : {} ),
    };
    const playerId = $('playerId').value;

    try {
      if (apiMode) {
        const isEdit = Boolean(playerId);
        const url = isEdit ? `${ENDPOINTS.players}/${encodeURIComponent(playerId)}` : ENDPOINTS.players;
        const method = isEdit ? 'PUT' : 'POST';
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData),
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err?.error || `HTTP ${res.status}`);
        }
        alert(`Player ${isEdit ? 'updated' : 'added'} (API mode)`);
        await loadPlayers();
      } else {
        if (playerId) {
          const idx = allPlayers.findIndex(p => p.name === playerId);
          if (idx !== -1) allPlayers[idx] = { ...allPlayers[idx], ...formData };
        } else {
          allPlayers.push(formData);
        }
        displayPlayers(allPlayers);
        updatePlayerCount(allPlayers.length);
        createPositionChart(allPlayers);
        alert(`Player ${playerId ? 'updated' : 'added'} (demo mode)`);
      }
    } catch (err) {
      alert(`Save failed: ${err.message}`);
    }
    resetForm();
    showSection('players');
  }

  async function deletePlayer(nameJson){
    const name = JSON.parse(nameJson);
    if (!confirm(`Delete ${name}?`)) return;
    try {
      if (apiMode) {
        const res = await fetch(`${ENDPOINTS.players}/${encodeURIComponent(name)}`, { method: 'DELETE' });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err?.error || `HTTP ${res.status}`);
        }
        await loadPlayers();
      } else {
        const idx = allPlayers.findIndex(p => p.name === name);
        if (idx !== -1) allPlayers.splice(idx,1);
        displayPlayers(allPlayers);
        updatePlayerCount(allPlayers.length);
        createPositionChart(allPlayers);
      }
    } catch (err) {
      alert(`Delete failed: ${err.message}`);
    }
  }

  // =============================
  // SEARCH & TOGGLE
  // =============================
  async function searchPlayers(query){
    currentSearch = (query || '').trim();
    if (apiMode) {
      currentPage = 1;
      await loadPlayers();
    } else {
      if (!currentSearch) { 
        displayPlayers(allPlayers); 
        createPositionChart(allPlayers);
        return; 
      }
      const q = currentSearch.toLowerCase();
      const filtered = allPlayers.filter(p =>
        (p.name || '').toLowerCase().includes(q) ||
        (p.position || '').toLowerCase().includes(q) ||
        (p.club || '').toLowerCase().includes(q) ||
        (getNationalityName(p.nationality) || '').toLowerCase().includes(q)
      );
      displayPlayers(filtered);
      createPositionChart(filtered);
    }
  }

  function searchScouts(query){
    const q = (query || '').trim().toLowerCase();
    if (!q) {
      displayScouts(allScouts);
      return;
    }
    
    const filtered = allScouts.filter(s =>
      (s.name || '').toLowerCase().includes(q) ||
      (s.region || '').toLowerCase().includes(q) ||
      (s.experience || '').toString().includes(q) ||
      (s.status || '').toLowerCase().includes(q)
    );
    displayScouts(filtered);
  }

  function searchClubs(query){
    const q = (query || '').trim().toLowerCase();
    if (!q) {
      displayClubs(allClubs);
      return;
    }
    
    const filtered = allClubs.filter(c =>
      (c.name || '').toLowerCase().includes(q) ||
      (c.country || '').toLowerCase().includes(q) ||
      (c.league || '').toLowerCase().includes(q) ||
      (c.stadium || '').toLowerCase().includes(q) ||
      (c.founded || '').toString().includes(q)
    );
    displayClubs(filtered);
  }

  function setToggleUI(on){
    const knob = document.getElementById('apiKnob');
    knob.style.transform = on ? 'translateX(20px)' : 'translateX(0)';
  }

  // =============================
  // EVENTS
  // =============================
  document.addEventListener('DOMContentLoaded', () => {
    // listeners
    $('playerForm').addEventListener('submit', handlePlayerSubmit);
    $('resetFormBtn').addEventListener('click', resetForm);
    $('cancelEditBtn').addEventListener('click', () => {
      resetForm();
      showSection('players');
    });
    $('addPlayerBtn').addEventListener('click', () => {
      resetForm();
      showSection('addEdit');
    });
    $('searchInput').addEventListener('input', (e) => searchPlayers(e.target.value));
    $('scoutSearchInput').addEventListener('input', (e) => searchScouts(e.target.value));
    $('clubSearchInput').addEventListener('input', (e) => searchClubs(e.target.value));
    $('apiToggle').addEventListener('change', async (e) => {
      apiMode = e.target.checked;
      setToggleUI(apiMode);
      await loadPlayers();
      await loadScouts();
      await loadClubs();
    });

    // Scout form handling
    $('addScoutBtn').addEventListener('click', () => {
      $('#scoutForm').reset();
      $('#scoutModalTitle').textContent = 'Add New Scout';
      $('#scoutForm').onsubmit = async function(e) {
        e.preventDefault();
        const scoutData = {
          name: $('#scoutName').value,
          region: $('#scoutRegion').value,
          experience: parseInt($('#scoutExperience').value) || 1,
          status: $('#scoutStatus').value
        };
        await addScout(scoutData);
        $('#addScoutModal').classList.add('hidden');
      };
      $('#addScoutModal').classList.remove('hidden');
    });

    $('cancelScoutBtn').addEventListener('click', () => {
      $('#addScoutModal').classList.add('hidden');
    });

    // Club form handling
    $('addClubBtn').addEventListener('click', () => {
      $('#clubForm').reset();
      $('#clubModalTitle').textContent = 'Add New Club';
      $('#clubForm').onsubmit = async function(e) {
        e.preventDefault();
        const clubData = {
          name: $('#clubName').value,
          country: $('#clubCountry').value,
          league: $('#clubLeague').value,
          stadium: $('#clubStadium').value,
          founded: parseInt($('#clubFounded').value) || 1900
        };
        await addClub(clubData);
        $('#addClubModal').classList.add('hidden');
      };
      $('#addClubModal').classList.remove('hidden');
    });

    $('cancelClubBtn').addEventListener('click', () => {
      $('#addClubModal').classList.add('hidden');
    });

    // Navigation click handlers
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = item.getAttribute('href').substring(1);
        showSection(targetId);
      });
    });

    // initial load in demo mode
    allPlayers = [...samplePlayers];
    allScouts = [...dummyScouts];
    allClubs = [...dummyClubs];
    displayPlayers(allPlayers);
    displayScouts(allScouts);
    displayClubs(allClubs);
    updatePlayerCount(allPlayers.length);
    updateScoutCount(allScouts.length);
    updateClubCount(allClubs.length);
    createPositionChart(allPlayers);
    createActivityChart();

    // Show the overview section by default
    showSection('overview');

    // Preload charts + API-driven widgets
    initDashboard();
  });
  </script>
</body>
</html>