<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Football Admin Dashboard</title>
  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome (icons) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- AOS (Animate On Scroll) -->
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <style>
    .connection-status { @apply flex items-center gap-2 text-sm px-2 py-1 rounded-full; }
    .connected   { @apply bg-green-100 text-green-700; }
    .disconnected{ @apply bg-yellow-100 text-yellow-700; }
    .error-banner{ @apply hidden mt-2 text-sm text-red-700 bg-red-100 border border-red-200 rounded p-2; }
    .loader      { @apply hidden text-sm text-gray-500; }
    .hidden-section { display: none; }
    .active-nav-item { @apply bg-slate-700; }
    /* Modal styles */
    .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; border-radius: 12px; width: 90%; max-width: 900px; }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close:hover, .close:focus { color: black; }
    .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
    .analytics-card { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    /* Custom animations */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .animate-pulse-custom {
      animation: pulse 2s infinite;
    }
    .progress-bar {
      height: 8px;
      border-radius: 4px;
      background-color: #e5e7eb;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 1s ease-in-out;
    }
    .fade-in {
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.5s ease, transform 0.5s ease;
    }
    .fade-in.visible {
      opacity: 1;
      transform: translateY(0);
    }
    .stats-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }
    .tabs button.active {
      border-bottom: 3px solid #3b82f6;
      color: #3b82f6;
    }
  </style>
</head>
<body class="min-h-screen bg-slate-50 flex">
  <!-- Sidebar (updated with Analytics) -->
  <aside class="w-64 bg-slate-800 text-white min-h-screen p-4 hidden md:block">
    <h2 class="text-xl font-bold mb-6">Dashboard</h2>
    <nav class="space-y-2">
      <a href="#overview" class="nav-item block px-3 py-2 rounded hover:bg-slate-700"><i class="fa-solid fa-gauge mr-2"></i>Overview</a>
      <a href="#players" class="nav-item block px-3 py-2 rounded hover:bg-slate-700"><i class="fa-solid fa-users mr-2"></i>Players</a>
      <a href="#scouts" class="nav-item block px-3 py-2 rounded hover:bg-slate-700"><i class="fa-solid fa-user-secret mr-2"></i>Scouts</a>
      <a href="#clubs" class="nav-item block px-3 py-2 rounded hover:bg-slate-700"><i class="fa-solid fa-building mr-2"></i>Clubs</a>
      <a href="#reports" class="nav-item block px-3 py-2 rounded hover:bg-slate-700"><i class="fa-solid fa-clipboard-list mr-2"></i>Reports</a>
      <a href="#analytics" class="nav-item block px-3 py-2 rounded hover:bg-slate-700"><i class="fa-solid fa-chart-line mr-2"></i>Analytics</a>
      <a href="#addEdit" class="nav-item block px-3 py-2 rounded hover:bg-slate-700"><i class="fa-solid fa-plus mr-2"></i>Add / Edit Player</a>
    </nav>
  </aside>

  <!-- Main content -->
  <div class="flex-1 flex flex-col">
    <!-- Top bar -->
    <header class="w-full bg-white border-b border-slate-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
        <h1 class="text-xl font-semibold text-slate-800">Football Admin Dashboard</h1>
        <div class="flex items-center gap-4">
          <!-- API Mode toggle -->
          <label class="inline-flex items-center cursor-pointer select-none">
            <input type="checkbox" id="apiToggle" class="sr-only" />
            <span class="mr-2 text-sm text-slate-600">API Mode</span>
            <span class="relative">
              <span class="block w-12 h-7 bg-slate-300 rounded-full shadow-inner"></span>
              <span id="apiKnob" class="absolute block w-6 h-6 bg-white rounded-full shadow -left-0.5 top-0.5 transition"></span>
            </span>
          </label>
          <div id="connectionStatus" class="connection-status disconnected">
            <i class="fas fa-plug"></i><span>Using Demo Data</span>
          </div>
        </div>
      </div>
    </header>

    <main class="flex-1 overflow-y-auto max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <!-- KPI Cards -->
      <section id="overview" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="stats-card bg-white rounded-2xl shadow p-4" data-aos="fade-up" data-aos-delay="0">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-slate-500">Players</p>
              <p class="text-3xl font-bold text-slate-800"><span id="playersCount">0</span></p>
              <p class="text-xs text-green-600 mt-1"><i class="fa-solid fa-arrow-up"></i> 12% from last month</p>
            </div>
            <div class="text-sky-600 text-2xl"><i class="fa-solid fa-users"></i></div>
          </div>
        </div>
        <div class="stats-card bg-white rounded-2xl shadow p-4" data-aos="fade-up" data-aos-delay="100">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-slate-500">Reports</p>
              <p class="text-3xl font-bold text-slate-800"><span id="reportsCount">0</span></p>
              <p class="text-xs text-red-600 mt-1"><i class="fa-solid fa-arrow-down"></i> 3% from last week</p>
            </div>
            <div class="text-emerald-600 text-2xl"><i class="fa-solid fa-clipboard-list"></i></div>
          </div>
        </div>
        <div class="stats-card bg-white rounded-2xl shadow p-4" data-aos="fade-up" data-aos-delay="200">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-slate-500">Clubs</p>
              <p class="text-3xl font-bold text-slate-800"><span id="clubsCount">0</span></p>
              <p class="text-xs text-green-600 mt-1"><i class="fa-solid fa-arrow-up"></i> 5% from last month</p>
            </div>
            <div class="text-indigo-600 text-2xl"><i class="fa-solid fa-building"></i></div>
          </div>
        </div>
        <div class="stats-card bg-white rounded-2xl shadow p-4" data-aos="fade-up" data-aos-delay="300">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-slate-500">Scouts</p>
              <p class="text-3xl font-bold text-slate-800"><span id="scoutsCount">0</span></p>
              <p class="text-xs text-gray-600 mt-1"><i class="fa-solid fa-minus"></i> No change</p>
            </div>
            <div class="text-rose-600 text-2xl"><i class="fa-solid fa-user-secret"></i></div>
          </div>
        </div>
      </section>

      <!-- Charts -->
      <section id="reports" class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-6">
        <div class="bg-white rounded-2xl shadow p-4" data-aos="fade-right">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-semibold text-slate-800">Positions Breakdown</h2>
            <button class="text-sm text-sky-600">View details</button>
          </div>
          <canvas id="positionsChart" height="140"></canvas>
        </div>
        <div class="bg-white rounded-2xl shadow p-4" data-aos="fade-left">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-semibold text-slate-800">Weekly Activity</h2>
            <button class="text-sm text-sky-600">View details</button>
          </div>
          <canvas id="activityChart" height="140"></canvas>
        </div>
      </section>

      <!-- Player Management -->
      <section id="players" class="bg-white rounded-2xl shadow mt-6">
        <div class="p-4 border-b border-slate-200 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
          <h2 class="text-lg font-semibold text-slate-800">Player Management</h2>
          <div class="flex items-center gap-2">
            <div class="relative">
              <input id="searchInput" type="text" placeholder="Search players by name, position or club..." class="w-64 border border-slate-200 rounded-xl py-2 pl-9 pr-3 text-sm focus:ring-2 focus:ring-sky-400 focus:outline-none" />
              <i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-slate-400"></i>
            </div>
            <button id="addPlayerBtn" class="inline-flex items-center gap-2 bg-sky-600 text-white text-sm font-medium px-3 py-2 rounded-xl hover:bg-sky-700">
              <i class="fa-solid fa-plus"></i> New Player
            </button>
          </div>
        </div>

        <div id="playersError" class="error-banner mx-4">Failed to load player data. Using demo data instead.</div>

        <div class="p-4">
          <div id="playersLoader" class="loader">Loading players…</div>
          <div class="overflow-x-auto">
            <table id="playersTable" class="min-w-full text-sm">
              <thead>
                <tr class="text-left text-slate-600 border-b">
                  <th class="py-2 pr-4">Name</th>
                  <th class="py-2 pr-4">Age</th>
                  <th class="py-2 pr-4">Position</th>
                  <th class="py-2 pr-4">Rating</th>
                  <th class="py-2 pr-4">Club</th>
                  <th class="py-2 pr-4">Nationality</th>
                  <th class="py-2 pr-4">Actions</th>
                </tr>
              </thead>
              <tbody id="playersTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Scouts Section (Hidden by default) -->
      <section id="scouts" class="hidden-section bg-white rounded-2xl shadow mt-6">
        <div class="p-4 border-b border-slate-200 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
          <h2 class="text-lg font-semibold text-slate-800">Scout Management</h2>
          <div class="flex items-center gap-2">
            <div class="relative">
              <input id="scoutSearchInput" type="text" placeholder="Search scouts by name or region..." class="w-64 border border-slate-200 rounded-xl py-2 pl-9 pr-3 text-sm focus:ring-2 focus:ring-sky-400 focus:outline-none" />
              <i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-slate-400"></i>
            </div>
            <button id="addScoutBtn" class="inline-flex items-center gap-2 bg-sky-600 text-white text-sm font-medium px-3 py-2 rounded-xl hover:bg-sky-700">
              <i class="fa-solid fa-plus"></i> New Scout
            </button>
          </div>
        </div>

        <div class="p-4">
          <div class="overflow-x-auto">
            <table id="scoutsTable" class="min-w-full text-sm">
              <thead>
                <tr class="text-left text-slate-600 border-b">
                  <th class="py-2 pr-4">Name</th>
                  <th class="py-2 pr-4">Region</th>
                  <th class="py-2 pr-4">Experience</th>
                  <th class="py-2 pr-4">Status</th>
                  <th class="py-2 pr-4">Players Found</th>
                  <th class="py-2 pr-4">Success Rate</th>
                  <th class="py-2 pr-4">Actions</th>
                </tr>
              </thead>
              <tbody id="scoutsTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Clubs Section (Hidden by default) -->
      <section id="clubs" class="hidden-section bg-white rounded-2xl shadow mt-6">
        <div class="p-4 border-b border-slate-200 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
          <h2 class="text-lg font-semibold text-slate-800">Club Management</h2>
          <div class="flex items-center gap-2">
            <div class="relative">
              <input id="clubSearchInput" type="text" placeholder="Search clubs by name or country..." class="w-64 border border-slate-200 rounded-xl py-2 pl-9 pr-3 text-sm focus:ring-2 focus:ring-sky-400 focus:outline-none" />
              <i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-slate-400"></i>
            </div>
            <button id="addClubBtn" class="inline-flex items-center gap-2 bg-sky-600 text-white text-sm font-medium px-3 py-2 rounded-xl hover:bg-sky-700">
              <i class="fa-solid fa-plus"></i> New Club
            </button>
          </div>
        </div>

        <div class="p-4">
          <div class="overflow-x-auto">
            <table id="clubsTable" class="min-w-full text-sm">
              <thead>
                <tr class="text-left text-slate-600 border-b">
                  <th class="py-2 pr-4">Name</th>
                  <th class="py-2 pr-4">Country</th>
                  <th class="py-2 pr-4">League</th>
                  <th class="py-2 pr-4">Players</th>
                  <th class="py-2 pr-4">Avg Rating</th>
                  <th class="py-2 pr-4">Budget</th>
                  <th class="py-2 pr-4">Actions</th>
                </tr>
              </thead>
              <tbody id="clubsTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Analytics Section -->
      <section id="analytics" class="hidden-section bg-white rounded-2xl shadow mt-6">
        <div class="p-4 border-b border-slate-200">
          <h2 class="text-lg font-semibold text-slate-800">Advanced Analytics</h2>
          <p class="text-sm text-slate-600">Comprehensive insights into players, clubs, and scouts performance</p>
        </div>
        
        <div class="tabs flex border-b border-slate-200">
          <button class="tab-btn py-3 px-6 text-sm font-medium active" data-tab="players-analytics">Players</button>
          <button class="tab-btn py-3 px-6 text-sm font-medium" data-tab="clubs-analytics">Clubs</button>
          <button class="tab-btn py-3 px-6 text-sm font-medium" data-tab="scouts-analytics">Scouts</button>
        </div>
        
        <!-- Players Analytics -->
        <div id="players-analytics" class="tab-content p-4">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-slate-50 rounded-xl p-4" data-aos="fade-up">
              <h3 class="text-lg font-medium mb-4">Player Ratings Distribution</h3>
              <canvas id="ratingsDistributionChart" height="250"></canvas>
            </div>
            
            <div class="bg-slate-50 rounded-xl p-4" data-aos="fade-up" data-aos-delay="100">
              <h3 class="text-lg font-medium mb-4">Top Performing Players</h3>
              <div id="topPlayersList" class="space-y-3">
                <!-- Will be populated dynamically -->
              </div>
            </div>
            
            <div class="bg-slate-50 rounded-xl p-4" data-aos="fade-up" data-aos-delay="200">
              <h3 class="text-lg font-medium mb-4">Age Distribution</h3>
              <canvas id="ageDistributionChart" height="250"></canvas>
            </div>
            
            <div class="bg-slate-50 rounded-xl p-4" data-aos="fade-up" data-aos-delay="300">
              <h3 class="text-lg font-medium mb-4">Nationality Distribution</h3>
              <canvas id="nationalityChart" height="250"></canvas>
            </div>
          </div>
        </div>
        
        <!-- Clubs Analytics -->
        <div id="clubs-analytics" class="tab-content p-4 hidden">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-slate-50 rounded-xl p-4" data-aos="fade-up">
              <h3 class="text-lg font-medium mb-4">Club Budget Comparison</h3>
              <canvas id="clubBudgetChart" height="250"></canvas>
            </div>
            
            <div class="bg-slate-50 rounded-xl p-4" data-aos="fade-up" data-aos-delay="100">
              <h3 class="text-lg font-medium mb-4">Player Count by Club</h3>
              <canvas id="playersPerClubChart" height="250"></canvas>
            </div>
            
            <div class="bg-slate-50 rounded-xl p-4" data-aos="fade-up" data-aos-delay="200">
              <h3 class="text-lg font-medium mb-4">Average Rating by Club</h3>
              <canvas id="clubRatingChart" height="250"></canvas>
            </div>
            
            <div class="bg-slate-50 rounded-xl p-4" data-aos="fade-up" data-aos-delay="300">
              <h3 class="text-lg font-medium mb-4">Geographical Distribution</h3>
              <div class="relative h-64 bg-slate-100 rounded-lg flex items-center justify-center">
                <div class="text-center">
                  <i class="fa-solid fa-earth-americas text-4xl text-slate-400 mb-2"></i>
                  <p class="text-slate-500">Interactive map visualization would appear here</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Scouts Analytics -->
        <div id="scouts-analytics" class="tab-content p-4 hidden">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-slate-50 rounded-xl p-4" data-aos="fade-up">
              <h3 class="text-lg font-medium mb-4">Scout Performance by Region</h3>
              <canvas id="scoutRegionChart" height="250"></canvas>
            </div>
            
            <div class="bg-slate-50 rounded-xl p-4" data-aos="fade-up" data-aos-delay="100">
              <h3 class="text-lg font-medium mb-4">Success Rate by Experience Level</h3>
              <canvas id="scoutExperienceChart" height="250"></canvas>
            </div>
            
            <div class="bg-slate-50 rounded-xl p-4" data-aos="fade-up" data-aos-delay="200">
              <h3 class="text-lg font-medium mb-4">Monthly Scout Activity</h3>
              <canvas id="scoutActivityChart" height="250"></canvas>
            </div>
            
            <div class="bg-slate-50 rounded-xl p-4" data-aos="fade-up" data-aos-delay="300">
              <h3 class="text-lg font-medium mb-4">Top Performing Scouts</h3>
              <div id="topScoutsList" class="space-y-4">
                <!-- Will be populated dynamically -->
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Add/Edit Player FORM at the END of the page -->
      <section id="addEdit" class="bg-white rounded-2xl shadow mt-6 p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 id="formTitle" class="text-lg font-semibold text-slate-800">Add Player</h3>
          <button id="resetFormBtn" class="text-sm text-slate-600 hover:text-slate-800"><i class="fa-solid fa-rotate-left mr-1"></i>Reset</button>
        </div>
        <form id="playerForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="hidden" id="playerId" />
          <div>
            <label class="block text-sm text-slate-600 mb-1">Name</label>
            <input id="name" class="w-full border border-slate-200 rounded-xl px-3 py-2" required />
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">Age</label>
            <input id="age" type="number" min="18" max="45" class="w-full border border-slate-200 rounded-xl px-3 py-2" />
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">Position</label>
            <select id="position" class="w-full border border-slate-200 rounded-xl px-3 py-2">
              <option>GK</option>
              <option>DEF</option>
              <option>MID</option>
              <option>FWD</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">Rating</label>
            <input id="rating" type="number" step="0.1" min="0" max="10" class="w-full border border-slate-200 rounded-xl px-3 py-2" />
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">Club</label>
            <input id="club" class="w-full border border-slate-200 rounded-xl px-3 py-2" />
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">Nationality</label>
            <select id="nationality" class="w-full border border-slate-200 rounded-xl px-3 py-2">
              <option value="ARG">Argentina</option>
              <option value="BRA">Brazil</option>
              <option value="ENG">England</option>
              <option value="FRA">France</option>
              <option value="GER">Germany</option>
              <option value="ITA">Italy</option>
              <option value="NED">Netherlands</option>
              <option value="POR">Portugal</option>
              <option value="ESP">Spain</option>
              <option value="URU">Uruguay</option>
            </select>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm text-slate-600 mb-1">Notes</label>
            <textarea id="notes" rows="3" class="w-full border border-slate-200 rounded-xl px-3 py-2"></textarea>
          </div>
          <div class="md:col-span-2 flex justify-end gap-2 mt-2">
            <button type="button" id="cancelEditBtn" class="px-4 py-2 rounded-xl border border-slate-200">Cancel</button>
            <button type="submit" class="px-4 py-2 rounded-xl bg-sky-600 text-white">Save</button>
          </div>
        </form>
      </section>
    </main>
  </div>

  <!-- Player Analytics Modal -->
  <div id="analyticsModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 class="text-xl font-semibold mb-4" id="analyticsPlayerName">Player Analytics</h2>
      
      <div class="analytics-grid">
        <div class="analytics-card">
          <h3 class="text-lg font-medium mb-2">Performance Overview</h3>
          <canvas id="performanceChart" height="200"></canvas>
        </div>
        
        <div class="analytics-card">
          <h3 class="text-lg font-medium mb-2">Position-Specific Metrics</h3>
          <canvas id="positionMetricsChart" height="200"></canvas>
        </div>
        
        <div class="analytics-card">
          <h3 class="text-lg font-medium mb-2">Performance Trend</h3>
          <canvas id="trendChart" height="200"></canvas>
        </div>
        
        <div class="analytics-card">
          <h3 class="text-lg font-medium mb-2">Key Statistics</h3>
          <div id="keyStats" class="space-y-2"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
  // =============================
  // API CONFIG
  // =============================
  const API_BASE = "https://players-flask-app.onrender.com"; // change if needed
  const ENDPOINTS = {
    players: `${API_BASE}/players`,
    playerReports: `${API_BASE}/player-reports`,
    scouts: `${API_BASE}/scouts`,
    clubs: `${API_BASE}/clubs`,
  };

  // =============================
  // STATE
  // =============================
  let apiMode = false; // toggled by switch
  let allPlayers = [];
  let allScouts = [];
  let allClubs = [];
  let currentPage = 1;
  let currentLimit = 50;
  let currentSearch = "";
  let activeSection = "overview"; // Track the active section
  let analyticsCharts = {}; // To store chart instances

  // Demo data fallback
  const samplePlayers = [
    { name: "John Smith", age: 22, position: "MID", rating: 7.4, club: "City FC", nationality: "ENG" },
    { name: "Pedro Alvarez", age: 25, position: "FWD", rating: 8.1, club: "United SC", nationality: "ESP" },
    { name: "Sizwe Mokoena", age: 21, position: "DEF", rating: 7.2, club: "Soweto Stars", nationality: "RSA" },
    { name: "Marco Rossi", age: 28, position: "GK",  rating: 7.8, club: "Milano AC", nationality: "ITA" },
    { name: "Lionel Messi", age: 35, position: "FWD", rating: 9.5, club: "Inter Miami", nationality: "ARG" },
    { name: "Cristiano Ronaldo", age: 37, position: "FWD", rating: 9.2, club: "Al Nassr", nationality: "POR" },
    { name: "Kylian Mbappé", age: 24, position: "FWD", rating: 9.0, club: "PSG", nationality: "FRA" },
    { name: "Kevin De Bruyne", age: 31, position: "MID", rating: 8.9, club: "Manchester City", nationality: "BEL" },
    { name: "Virgil van Dijk", age: 31, position: "DEF", rating: 8.7, club: "Liverpool", nationality: "NED" },
    { name: "Manuel Neuer", age: 36, position: "GK", rating: 8.6, club: "Bayern Munich", nationality: "GER" },
  ];

  // Dummy scouts data
  const dummyScouts = [
    { name: "James Wilson", region: "Europe", experience: "Senior", status: "Active", playersFound: 24, totalScouted: 35 },
    { name: "Maria Rodriguez", region: "South America", experience: "Mid-level", status: "Active", playersFound: 18, totalScouted: 25 },
    { name: "David Chen", region: "Asia", experience: "Junior", status: "Training", playersFound: 12, totalScouted: 20 },
    { name: "Sarah Johnson", region: "North America", experience: "Senior", status: "Active", playersFound: 22, totalScouted: 30 },
    { name: "Ahmed Hassan", region: "Africa", experience: "Mid-level", status: "On Leave", playersFound: 15, totalScouted: 22 },
    { name: "Emma Thompson", region: "Europe", experience: "Senior", status: "Active", playersFound: 28, totalScouted: 35 },
    { name: "Carlos Mendez", region: "Central America", experience: "Junior", status: "Active", playersFound: 9, totalScouted: 15 },
    { name: "Lisa Brown", region: "Oceania", experience: "Mid-level", status: "Active", playersFound: 14, totalScouted: 20 }
  ];

  // Dummy clubs data
  const dummyClubs = [
    { name: "City FC", country: "England", league: "Premier League", playerCount: 28, avgRating: 7.8, budget: 500000000 },
    { name: "United SC", country: "Spain", league: "La Liga", playerCount: 25, avgRating: 7.6, budget: 450000000 },
    { name: "Soweto Stars", country: "South Africa", league: "PSL", playerCount: 22, avgRating: 6.9, budget: 25000000 },
    { name: "Milano AC", country: "Italy", league: "Serie A", playerCount: 26, avgRating: 7.7, budget: 400000000 },
    { name: "Bayern Munich", country: "Germany", league: "Bundesliga", playerCount: 27, avgRating: 8.1, budget: 550000000 },
    { name: "PSG", country: "France", league: "Ligue 1", playerCount: 25, avgRating: 8.2, budget: 600000000 }
  ];

  // Available positions
  const positions = ["GK", "DEF", "MID", "FWD"];

  // Available nationalities with country codes and names
  const nationalities = [
    { code: "ARG", name: "Argentina" },
    { code: "BEL", name: "Belgium" },
    { code: "BRA", name: "Brazil" },
    { code: "COL", name: "Colombia" },
    { code: "CRO", name: "Croatia" },
    { code: "ENG", name: "England" },
    { code: "FRA", name: "France" },
    { code: "GER", name: "Germany" },
    { code: "ITA", name: "Italy" },
    { code: "NED", name: "Netherlands" },
    { code: "POR", name: "Portugal" },
    { code: "ESP", name: "Spain" },
    { code: "URU", name: "Uruguay" },
    { code: "USA", name: "United States" },
    { code: "RSA", name: "South Africa" },
    { code: "EGY", name: "Egypt" },
    { code: "NGA", name: "Nigeria" },
    { code: "JPN", name: "Japan" },
    { code: "KOR", name: "South Korea" },
    { code: "MEX", name: "Mexico" }
  ];

  // Position-specific metrics
  const positionMetrics = {
    GK: ['Saves', 'Clean Sheets', 'Aerial Duels', 'Pass Accuracy', 'Punches'],
    DEF: ['Tackles', 'Interceptions', 'Clearances', 'Aerial Duels', 'Pass Accuracy'],
    MID: ['Pass Accuracy', 'Key Passes', 'Dribbles', 'Tackles', 'Distance Covered'],
    FWD: ['Goals', 'Shots on Target', 'Dribbles', 'Key Passes', 'Aerial Duels']
  };

  // =============================
  // NORMALIZER (fix age + position + nationality)
  // =============================
  function normalizePlayer(p){
    // Generate a random age between 18 and 45
    let age = Math.floor(Math.random() * (45 - 18 + 1)) + 18;

    // Generate a random position
    let position = positions[Math.floor(Math.random() * positions.length)];

    // Generate a random nationality
    let nationality = nationalities[Math.floor(Math.random() * nationalities.length)].code;

    // Rating: coerce to number if numeric
    let rating = p.rating ?? p.Rating ?? p["Original Rating"] ?? p["Alternative Rating"];
    if (rating !== undefined && rating !== null && rating !== '') {
      const n = Number(rating);
      rating = isNaN(n) ? rating : n;
    }

    return {
      name: p.name || p.Name || 'N/A',
      age,
      position,
      rating: rating ?? 'N/A',
      club: p.club || p["Team Name"] || p.Team || 'N/A',
      nationality,
      notes: p.notes || p.Notes || ''
    };
  }

  // Helper function to get nationality name from code
  function getNationalityName(code) {
    const nationality = nationalities.find(n => n.code === code);
    return nationality ? nationality.name : code;
  }

  // =============================
  // HELPERS
  // =============================
  function $(id){ return document.getElementById(id); }

  function animateValue(el, start, end, duration) {
    const s = Number(start)||0, e = Number(end)||0, range = e - s;
    if (!range) { el.textContent = String(e); return; }
    const t0 = performance.now();
    function tick(t){
      const k = Math.min((t - t0) / duration, 1);
      el.textContent = String(Math.floor(s + range * k));
      if (k < 1) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  }

  function showLoader(loaderId, tableId){
    $(loaderId).classList.remove('hidden');
    if (tableId) $(tableId).classList.add('opacity-50');
  }
  function hideLoader(loaderId, tableId){
    $(loaderId).classList.add('hidden');
    if (tableId) $(tableId).classList.remove('opacity-50');
  }
  function showError(id, msg){ const el=$(id); el.textContent=msg; el.classList.remove('hidden'); }
  function hideError(id){ $(id).classList.add('hidden'); }

  function updatePlayerCount(n){
    const el = $('playersCount');
    animateValue(el, Number(el.textContent)||0, n, 800);
  }

  function displayPlayers(list){
    const tbody = $('playersTbody');
    tbody.innerHTML = '';
    list.forEach(p => {
      const tr = document.createElement('tr');
      tr.className = 'border-b hover:bg-slate-50 fade-in';
      tr.innerHTML = `
        <td class="py-2 pr-4 font-medium text-slate-800">${p.name ?? 'N/A'}</td>
        <td class="py-2 pr-4">${p.age ?? '—'}</td>
        <td class="py-2 pr-4">${p.position ?? '—'}</td>
        <td class="py-2 pr-4">${p.rating ?? '—'}</td>
        <td class="py-2 pr-4">${p.club ?? '—'}</td>
        <td class="py-2 pr-4">${getNationalityName(p.nationality) ?? '—'}</td>
        <td class="py-2 pr-4">
          <button class="text-sky-600 hover:underline mr-2" onclick='populateForm(${JSON.stringify(JSON.stringify(p))})'>Edit</button>
          <button class="text-indigo-600 hover:underline mr-2" onclick='showPlayerAnalytics(${JSON.stringify(JSON.stringify(p))})'>Analytics</button>
          <button class="text-rose-600 hover:underline" onclick='deletePlayer(${JSON.stringify(JSON.stringify(p.name))})'>Delete</button>
        </td>`;
      tbody.appendChild(tr);
      
      // Add animation with delay
      setTimeout(() => {
        tr.classList.add('visible');
      }, 50);
    });
  }

  function displayScouts(list){
    const tbody = $('scoutsTbody');
    tbody.innerHTML = '';
    list.forEach(s => {
      const tr = document.createElement('tr');
      tr.className = 'border-b hover:bg-slate-50 fade-in';
      
      // Calculate success rate
      const successRate = Math.round((s.playersFound / s.totalScouted) * 100);
      
      // Determine status color
      let statusColor = 'text-gray-600';
      if (s.status === 'Active') statusColor = 'text-green-600';
      if (s.status === 'On Leave') statusColor = 'text-yellow-600';
      if (s.status === 'Training') statusColor = 'text-blue-600';
      
      tr.innerHTML = `
        <td class="py-2 pr-4 font-medium text-slate-800">${s.name ?? 'N/A'}</td>
        <td class="py-2 pr-4">${s.region ?? '—'}</td>
        <td class="py-2 pr-4">${s.experience ?? '—'}</td>
        <td class="py-2 pr-4 ${statusColor}">${s.status ?? '—'}</td>
        <td class="py-2 pr-4">${s.playersFound ?? '—'}</td>
        <td class="py-2 pr-4">
          <div class="flex items-center">
            <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
              <div class="bg-green-600 h-2 rounded-full" style="width: ${successRate}%"></div>
            </div>
            <span>${successRate}%</span>
          </div>
        </td>
        <td class="py-2 pr-4">
          <button class="text-sky-600 hover:underline mr-2">Edit</button>
          <button class="text-rose-600 hover:underline">Delete</button>
        </td>`;
      tbody.appendChild(tr);
      
      // Add animation with delay
      setTimeout(() => {
        tr.classList.add('visible');
      }, 50);
    });
  }

  function displayClubs(list){
    const tbody = $('clubsTbody');
    tbody.innerHTML = '';
    list.forEach(c => {
      const tr = document.createElement('tr');
      tr.className = 'border-b hover:bg-slate-50 fade-in';
      
      // Format budget
      const budgetFormatted = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(c.budget);
      
      tr.innerHTML = `
        <td class="py-2 pr-4 font-medium text-slate-800">${c.name ?? 'N/A'}</td>
        <td class="py-2 pr-4">${c.country ?? '—'}</td>
        <td class="py-2 pr-4">${c.league ?? '—'}</td>
        <td class="py-2 pr-4">${c.playerCount ?? '—'}</td>
        <td class="py-2 pr-4">${c.avgRating ?? '—'}</td>
        <td class="py-2 pr-4">${budgetFormatted}</td>
        <td class="py-2 pr-4">
          <button class="text-sky-600 hover:underline mr-2">Edit</button>
          <button class="text-rose-600 hover:underline">Delete</button>
        </td>`;
      tbody.appendChild(tr);
      
      // Add animation with delay
      setTimeout(() => {
        tr.classList.add('visible');
      }, 50);
    });
  }

  // Calculate position counts for the chart
  function calculatePositionCounts(players) {
    const counts = {
      "GK": 0,
      "DEF": 0,
      "MID": 0,
      "FWD": 0
    };
    
    players.forEach(player => {
      if (player.position && counts.hasOwnProperty(player.position)) {
        counts[player.position]++;
      }
    });
    
    return counts;
  }

  // charts
  let positionsChart, activityChart;
  function createPositionChart(players){
    const ctx = document.getElementById('positionsChart');
    const positionCounts = calculatePositionCounts(players);
    const labels = Object.keys(positionCounts);
    const values = Object.values(positionCounts);
    
    // Define colors for each position
    const backgroundColors = [
      'rgba(255, 99, 132, 0.7)',  // GK - Pink
      'rgba(54, 162, 235, 0.7)',  // DEF - Blue
      'rgba(255, 206, 86, 0.7)',  // MID - Yellow
      'rgba(75, 192, 192, 0.7)'   // FWD - Teal
    ];
    
    if (positionsChart) positionsChart.destroy();
    positionsChart = new Chart(ctx, {
      type: 'doughnut',
      data: { 
        labels, 
        datasets: [{ 
          data: values,
          backgroundColor: backgroundColors,
          borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
          borderWidth: 1
        }] 
      },
      options: { 
        responsive: true, 
        plugins: { 
          legend: { 
            position: 'bottom' 
          } 
        },
        animation: {
          animateScale: true,
          animateRotate: true
        }
      }
    });
  }
  
  function createActivityChart(){
    const ctx = document.getElementById('activityChart');
    const labels = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    const values = labels.map(() => Math.floor(Math.random()*20)+5);
    if (activityChart) activityChart.destroy();
    activityChart = new Chart(ctx, {
      type: 'line',
      data: { 
        labels, 
        datasets: [{ 
          label: 'Events', 
          data: values, 
          tension: 0.35, 
          fill: true,
          backgroundColor: 'rgba(54, 162, 235, 0.2)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 2,
          pointBackgroundColor: 'rgba(54, 162, 235, 1)'
        }] 
      },
      options: { 
        responsive: true, 
        plugins: { 
          legend: { 
            display: false 
          } 
        },
        animation: {
          duration: 2000,
          easing: 'easeOutQuart'
        }
      }
    });
  }

  // =============================
  // ANALYTICS CHARTS
  // =============================
  function createRatingsDistributionChart(players) {
    const ctx = document.getElementById('ratingsDistributionChart');
    const ratings = players.map(p => p.rating).filter(r => typeof r === 'number');
    
    // Create rating ranges
    const ranges = [
      { min: 0, max: 5.9, label: '0-5.9' },
      { min: 6, max: 6.9, label: '6.0-6.9' },
      { min: 7, max: 7.9, label: '7.0-7.9' },
      { min: 8, max: 8.9, label: '8.0-8.9' },
      { min: 9, max: 10, label: '9.0-10' }
    ];
    
    const data = ranges.map(range => {
      return ratings.filter(r => r >= range.min && r <= range.max).length;
    });
    
    const chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ranges.map(r => r.label),
        datasets: [{
          label: 'Number of Players',
          data: data,
          backgroundColor: 'rgba(54, 162, 235, 0.7)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Number of Players'
            }
          },
          x: {
            title: {
              display: true,
              text: 'Rating Range'
            }
          }
        },
        animation: {
          duration: 2000,
          easing: 'easeOutBounce'
        }
      }
    });
    
    analyticsCharts.ratingsDistribution = chart;
  }
  
  function createAgeDistributionChart(players) {
    const ctx = document.getElementById('ageDistributionChart');
    const ages = players.map(p => p.age).filter(a => typeof a === 'number');
    
    // Create age ranges
    const ranges = [
      { min: 18, max: 21, label: '18-21' },
      { min: 22, max: 25, label: '22-25' },
      { min: 26, max: 29, label: '26-29' },
      { min: 30, max: 33, label: '30-33' },
      { min: 34, max: 45, label: '34+' }
    ];
    
    const data = ranges.map(range => {
      return ages.filter(a => a >= range.min && a <= range.max).length;
    });
    
    const chart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: ranges.map(r => r.label),
        datasets: [{
          data: data,
          backgroundColor: [
            'rgba(255, 99, 132, 0.7)',
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 206, 86, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(153, 102, 255, 0.7)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom'
          }
        },
        animation: {
          animateScale: true,
          animateRotate: true
        }
      }
    });
    
    analyticsCharts.ageDistribution = chart;
  }
  
  function createNationalityChart(players) {
    const ctx = document.getElementById('nationalityChart');
    const nationalityCounts = {};
    
    players.forEach(player => {
      if (player.nationality) {
        const countryName = getNationalityName(player.nationality);
        nationalityCounts[countryName] = (nationalityCounts[countryName] || 0) + 1;
      }
    });
    
    // Get top 5 nationalities
    const topNationalities = Object.entries(nationalityCounts)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5);
    
    const labels = topNationalities.map(n => n[0]);
    const data = topNationalities.map(n => n[1]);
    
    const chart = new Chart(ctx, {
      type: 'polarArea',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: [
            'rgba(255, 99, 132, 0.7)',
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 206, 86, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(153, 102, 255, 0.7)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom'
          }
        },
        animation: {
          animateRotate: true,
          animateScale: true
        }
      }
    });
    
    analyticsCharts.nationality = chart;
  }
  
  function createClubBudgetChart(clubs) {
    const ctx = document.getElementById('clubBudgetChart');
    const labels = clubs.map(c => c.name);
    const data = clubs.map(c => c.budget / 1000000); // Convert to millions
    
    const chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Budget (Millions $)',
          data: data,
          backgroundColor: 'rgba(75, 192, 192, 0.7)',
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Budget (Millions $)'
            }
          }
        },
        animation: {
          duration: 2000,
          easing: 'easeOutBounce'
        }
      }
    });
    
    analyticsCharts.clubBudget = chart;
  }
  
  function createPlayersPerClubChart(clubs) {
    const ctx = document.getElementById('playersPerClubChart');
    const labels = clubs.map(c => c.name);
    const data = clubs.map(c => c.playerCount);
    
    const chart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: [
            'rgba(255, 99, 132, 0.7)',
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 206, 86, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(153, 102, 255, 0.7)',
            'rgba(255, 159, 64, 0.7)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom'
          }
        },
        animation: {
          animateScale: true,
          animateRotate: true
        }
      }
    });
    
    analyticsCharts.playersPerClub = chart;
  }
  
  function createClubRatingChart(clubs) {
    const ctx = document.getElementById('clubRatingChart');
    const labels = clubs.map(c => c.name);
    const data = clubs.map(c => c.avgRating);
    
    const chart = new Chart(ctx, {
      type: 'radar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Average Rating',
          data: data,
          backgroundColor: 'rgba(54, 162, 235, 0.2)',
          borderColor: 'rgba(54, 162, 235, 1)',
          pointBackgroundColor: 'rgba(54, 162, 235, 1)',
          pointBorderColor: '#fff',
          pointHoverBackgroundColor: '#fff',
          pointHoverBorderColor: 'rgba(54, 162, 235, 1)'
        }]
      },
      options: {
        responsive: true,
        scales: {
          r: {
            beginAtZero: true,
            max: 10,
            ticks: {
              stepSize: 1
            }
          }
        },
        animation: {
          duration: 2000,
          easing: 'easeOutBack'
        }
      }
    });
    
    analyticsCharts.clubRating = chart;
  }
  
  function createScoutRegionChart(scouts) {
    const ctx = document.getElementById('scoutRegionChart');
    const regionCounts = {};
    
    scouts.forEach(scout => {
      if (scout.region) {
        regionCounts[scout.region] = (regionCounts[scout.region] || 0) + 1;
      }
    });
    
    const labels = Object.keys(regionCounts);
    const data = Object.values(regionCounts);
    
    const chart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: [
            'rgba(255, 99, 132, 0.7)',
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 206, 86, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(153, 102, 255, 0.7)',
            'rgba(255, 159, 64, 0.7)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom'
          }
        },
        animation: {
          animateScale: true,
          animateRotate: true
        }
      }
    });
    
    analyticsCharts.scoutRegion = chart;
  }
  
  function createScoutExperienceChart(scouts) {
    const ctx = document.getElementById('scoutExperienceChart');
    const experienceLevels = {};
    
    scouts.forEach(scout => {
      if (scout.experience) {
        experienceLevels[scout.experience] = (experienceLevels[scout.experience] || 0) + 1;
      }
    });
    
    const labels = Object.keys(experienceLevels);
    const data = Object.values(experienceLevels);
    
    const chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Number of Scouts',
          data: data,
          backgroundColor: 'rgba(153, 102, 255, 0.7)',
          borderColor: 'rgba(153, 102, 255, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Number of Scouts'
            }
          }
        },
        animation: {
          duration: 2000,
          easing: 'easeOutBounce'
        }
      }
    });
    
    analyticsCharts.scoutExperience = chart;
  }
  
  function createScoutActivityChart() {
    const ctx = document.getElementById('scoutActivityChart');
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const data = months.map(() => Math.floor(Math.random() * 50) + 20);
    
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: months,
        datasets: [{
          label: 'Scout Reports',
          data: data,
          fill: false,
          borderColor: 'rgba(255, 159, 64, 1)',
          tension: 0.1,
          pointBackgroundColor: 'rgba(255, 159, 64, 1)'
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Number of Reports'
            }
          }
        },
        animation: {
          duration: 2000,
          easing: 'easeOutQuart'
        }
      }
    });
    
    analyticsCharts.scoutActivity = chart;
  }
  
  function populateTopPlayersList(players) {
    const container = $('#topPlayersList');
    container.innerHTML = '';
    
    // Sort players by rating (highest first) and take top 5
    const topPlayers = [...players]
      .filter(p => typeof p.rating === 'number')
      .sort((a, b) => b.rating - a.rating)
      .slice(0, 5);
    
    topPlayers.forEach((player, index) => {
      const playerEl = document.createElement('div');
      playerEl.className = 'flex items-center justify-between p-3 bg-white rounded-lg shadow-sm';
      playerEl.innerHTML = `
        <div class="flex items-center">
          <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center mr-3 font-bold ${index < 3 ? 'text-yellow-600' : 'text-slate-600'}">
            ${index + 1}
          </div>
          <div>
            <div class="font-medium">${player.name}</div>
            <div class="text-sm text-slate-500">${player.club} • ${player.position}</div>
          </div>
        </div>
        <div class="text-lg font-bold text-sky-600">${player.rating.toFixed(1)}</div>
      `;
      container.appendChild(playerEl);
    });
  }
  
  function populateTopScoutsList(scouts) {
    const container = $('#topScoutsList');
    container.innerHTML = '';
    
    // Calculate success rate for each scout and sort by it
    const scoutsWithSuccess = scouts.map(scout => {
      const successRate = Math.round((scout.playersFound / scout.totalScouted) * 100);
      return { ...scout, successRate };
    });
    
    // Sort by success rate (highest first) and take top 5
    const topScouts = scoutsWithSuccess
      .sort((a, b) => b.successRate - a.successRate)
      .slice(0, 5);
    
    topScouts.forEach((scout, index) => {
      const scoutEl = document.createElement('div');
      scoutEl.className = 'flex items-center justify-between p-3 bg-white rounded-lg shadow-sm';
      scoutEl.innerHTML = `
        <div class="flex items-center">
          <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center mr-3 font-bold ${index < 3 ? 'text-yellow-600' : 'text-slate-600'}">
            ${index + 1}
          </div>
          <div>
            <div class="font-medium">${scout.name}</div>
            <div class="text-sm text-slate-500">${scout.region} • ${scout.experience}</div>
          </div>
        </div>
        <div class="text-right">
          <div class="text-lg font-bold text-green-600">${scout.successRate}%</div>
          <div class="text-sm text-slate-500">${scout.playersFound}/${scout.totalScouted}</div>
        </div>
      `;
      container.appendChild(scoutEl);
    });
  }

  // =============================
  // PLAYER ANALYTICS FUNCTIONS
  // =============================
  function showPlayerAnalytics(playerJson) {
    const player = playerJson ? JSON.parse(playerJson) : null;
    if (!player) return;
    
    // Set player name in modal
    $('#analyticsPlayerName').textContent = `${player.name} - Analytics`;
    
    // Generate random performance data for the player
    const performanceData = generatePerformanceData(player);
    
    // Create charts
    createPerformanceChart(performanceData.overall);
    createPositionMetricsChart(performanceData.positionMetrics, player.position);
    createTrendChart(performanceData.trend);
    displayKeyStats(performanceData.keyStats);
    
    // Show the modal
    $('#analyticsModal').style.display = 'block';
  }

  function generatePerformanceData(player) {
    // Generate random data based on player position and rating
    const baseRating = typeof player.rating === 'number' ? player.rating : 7.0;
    
    // Overall performance metrics
    const overallMetrics = {
      'Attack': Math.min(10, (baseRating / 10) * (8 + Math.random() * 2)),
      'Defense': Math.min(10, (baseRating / 10) * (6 + Math.random() * 2)),
      'Technique': Math.min(10, (baseRating / 10) * (7 + Math.random() * 2)),
      'Physical': Math.min(10, (baseRating / 10) * (7 + Math.random() * 2)),
      'Mental': Math.min(10, (baseRating / 10) * (7 + Math.random() * 2))
    };
    
    // Position-specific metrics
    const posMetrics = {};
    const metrics = positionMetrics[player.position] || positionMetrics.MID;
    metrics.forEach(metric => {
      posMetrics[metric] = Math.min(10, (baseRating / 10) * (7 + Math.random() * 3));
    });
    
    // Performance trend (last 6 matches)
    const trend = [];
    for (let i = 0; i < 6; i++) {
      trend.push(Math.max(5, Math.min(10, baseRating + (Math.random() * 2 - 1))));
    }
    
    // Key statistics
    const keyStats = {
      'Matches Played': Math.floor(Math.random() * 30) + 10,
      'Goals': player.position === 'FWD' ? Math.floor(Math.random() * 20) + 5 : Math.floor(Math.random() * 10),
      'Assists': player.position !== 'GK' ? Math.floor(Math.random() * 15) + 2 : 0,
      'Yellow Cards': Math.floor(Math.random() * 10),
      'Red Cards': Math.floor(Math.random() * 3),
      'Minutes Played': Math.floor(Math.random() * 2500) + 500
    };
    
    return {
      overall: overallMetrics,
      positionMetrics: posMetrics,
      trend: trend,
      keyStats: keyStats
    };
  }

  function createPerformanceChart(data) {
    const ctx = document.getElementById('performanceChart');
    
    // Destroy previous chart if it exists
    if (analyticsCharts.performance) {
      analyticsCharts.performance.destroy();
    }
    
    analyticsCharts.performance = new Chart(ctx, {
      type: 'radar',
      data: {
        labels: Object.keys(data),
        datasets: [{
          label: 'Performance',
          data: Object.values(data),
          backgroundColor: 'rgba(54, 162, 235, 0.2)',
          borderColor: 'rgba(54, 162, 235, 1)',
          pointBackgroundColor: 'rgba(54, 162, 235, 1)',
          pointBorderColor: '#fff',
          pointHoverBackgroundColor: '#fff',
          pointHoverBorderColor: 'rgba(54, 162, 235, 1)'
        }]
      },
      options: {
        scales: {
          r: {
            beginAtZero: true,
            max: 10,
            ticks: {
              stepSize: 2
            }
          }
        },
        animation: {
          duration: 2000,
          easing: 'easeOutBack'
        }
      }
    });
  }

  function createPositionMetricsChart(data, position) {
    const ctx = document.getElementById('positionMetricsChart');
    
    // Destroy previous chart if it exists
    if (analyticsCharts.positionMetrics) {
      analyticsCharts.positionMetrics.destroy();
    }
    
    // Adjust the chart type based on position
    const chartType = position === 'GK' ? 'bar' : 'bar';
    
    analyticsCharts.positionMetrics = new Chart(ctx, {
      type: chartType,
      data: {
        labels: Object.keys(data),
        datasets: [{
          label: 'Score',
          data: Object.values(data),
          backgroundColor: [
            'rgba(255, 99, 132, 0.7)',
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 206, 86, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(153, 102, 255, 0.7)'
          ],
          borderColor: [
            'rgba(255, 99, 132, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(153, 102, 255, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        indexAxis: 'y',
        scales: {
          x: {
            beginAtZero: true,
            max: 10
          }
        },
        animation: {
          duration: 2000,
          easing: 'easeOutBounce'
        }
      }
    });
  }

  function createTrendChart(data) {
    const ctx = document.getElementById('trendChart');
    const matches = data.map((_, i) => `Match ${i + 1}`);
    
    // Destroy previous chart if it exists
    if (analyticsCharts.trend) {
      analyticsCharts.trend.destroy();
    }
    
    analyticsCharts.trend = new Chart(ctx, {
      type: 'line',
      data: {
        labels: matches,
        datasets: [{
          label: 'Rating',
          data: data,
          fill: false,
          borderColor: 'rgba(75, 192, 192, 1)',
          tension: 0.1,
          pointBackgroundColor: 'rgba(75, 192, 192, 1)'
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: false,
            min: 5,
            max: 10
          }
        },
        animation: {
          duration: 2000,
          easing: 'easeOutQuart'
        }
      }
    });
  }

  function displayKeyStats(stats) {
    const container = $('#keyStats');
    container.innerHTML = '';
    
    for (const [key, value] of Object.entries(stats)) {
      const statElement = document.createElement('div');
      statElement.className = 'flex justify-between';
      statElement.innerHTML = `
        <span class="text-slate-600">${key}:</span>
        <span class="font-medium">${value}</span>
      `;
      container.appendChild(statElement);
    }
  }

  // Close the analytics modal
  function setupAnalyticsModal() {
    const modal = $('#analyticsModal');
    const closeBtn = document.getElementsByClassName('close')[0];
    
    closeBtn.onclick = function() {
      modal.style.display = 'none';
    };
    
    window.onclick = function(event) {
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    };
  }

  // =============================
  // SECTION NAVIGATION
  // =============================
  function showSection(sectionId) {
    // Hide all sections
    document.querySelectorAll('main > section').forEach(section => {
      section.classList.add('hidden-section');
    });
    
    // Show the selected section
    const targetSection = $(sectionId);
    if (targetSection) {
      targetSection.classList.remove('hidden-section');
    }
    
    // Update active nav item
    document.querySelectorAll('.nav-item').forEach(item => {
      item.classList.remove('active-nav-item');
    });
    
    const activeNavItem = document.querySelector(`.nav-item[href="#${sectionId}"]`);
    if (activeNavItem) {
      activeNavItem.classList.add('active-nav-item');
    }
    
    // Update active section
    activeSection = sectionId;
    
    // Load specific data if needed
    if (sectionId === 'scouts') {
      loadScouts();
    } else if (sectionId === 'clubs') {
      loadClubs();
    } else if (sectionId === 'analytics') {
      loadAnalytics();
    }
  }

  // Tab switching in analytics section
  function setupAnalyticsTabs() {
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const tabId = button.getAttribute('data-tab');
        
        // Update active tab button
        tabButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        
        // Show selected tab content
        tabContents.forEach(content => content.classList.add('hidden'));
        $(tabId).classList.remove('hidden');
      });
    });
  }

  // =============================
  // CORE LOADERS
  // =============================
  async function initDashboard(){
    try {
      // players widget + table (use API directly once to get counts)
      const resPlayers = await fetch(`${ENDPOINTS.players}?page=1&limit=50`);
      const playersPayload = await resPlayers.json(); // { total_players, players, ... }
      const total = Number(playersPayload?.total_players ?? 0);
      $('playersCount').textContent = total;
      animateValue($('playersCount'), 0, total, 1000);

      // placeholder KPIs
      $('reportsCount').textContent = String(Math.floor(Math.random()*10)+5);
      $('clubsCount').textContent = String(dummyClubs.length);
      $('scoutsCount').textContent = String(dummyScouts.length);

      animateValue($('reportsCount'), 0, Number($('reportsCount').textContent), 1000);
      animateValue($('clubsCount'),   0, Number($('clubsCount').textContent),   1000);
      animateValue($('scoutsCount'),  0, Number($('scoutsCount').textContent),  1000);

      await loadPlayers();
    } catch (err) {
      console.error('❌ Error loading dashboard:', err);
      allPlayers = [...samplePlayers];
      displayPlayers(allPlayers);
      updatePlayerCount(allPlayers.length);
      createPositionChart(allPlayers);
      createActivityChart();
    }
  }

  async function loadPlayers(){
    try {
      showLoader('playersLoader','playersTable');
      hideError('playersError');

      if (apiMode) {
        const qs = new URLSearchParams({
          page: String(currentPage),
          limit: String(currentLimit),
          ...(currentSearch ? { name: currentSearch } : {}),
        });
        const res = await fetch(`${ENDPOINTS.players}?${qs.toString()}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const payload = await res.json();
        const raw = Array.isArray(payload.players) ? payload.players : [];
        allPlayers = raw.map(normalizePlayer);
        $('connectionStatus').className = 'connection-status connected';
        $('connectionStatus').innerHTML = '<i class="fas fa-plug"></i><span>Connected to API</span>';
        displayPlayers(allPlayers);
        updatePlayerCount(Number(payload.total_players ?? allPlayers.length));
        createPositionChart(allPlayers);
      } else {
        allPlayers = [...samplePlayers];
        $('connectionStatus').className = 'connection-status disconnected';
        $('connectionStatus').innerHTML = '<i class="fas fa-plug"></i><span>Using Demo Data</span>';
        displayPlayers(allPlayers);
        updatePlayerCount(allPlayers.length);
        createPositionChart(allPlayers);
      }
      hideLoader('playersLoader','playersTable');
    } catch (error) {
      console.error('Error loading players:', error);
      allPlayers = [...samplePlayers];
      displayPlayers(allPlayers);
      updatePlayerCount(allPlayers.length);
      createPositionChart(allPlayers);
      showError('playersError','Failed to load player data. Using demo data instead.');
      hideLoader('playersLoader','playersTable');
    }
  }

  function loadScouts() {
    allScouts = [...dummyScouts];
    displayScouts(allScouts);
  }
  
  function loadClubs() {
    allClubs = [...dummyClubs];
    displayClubs(allClubs);
  }
  
  function loadAnalytics() {
    // Create all analytics charts
    createRatingsDistributionChart(allPlayers);
    createAgeDistributionChart(allPlayers);
    createNationalityChart(allPlayers);
    createClubBudgetChart(allClubs);
    createPlayersPerClubChart(allClubs);
    createClubRatingChart(allClubs);
    createScoutRegionChart(allScouts);
    createScoutExperienceChart(allScouts);
    createScoutActivityChart();
    
    // Populate top players and scouts lists
    populateTopPlayersList(allPlayers);
    populateTopScoutsList(allScouts);
  }

  // =============================
  // FORM UX (bottom form)
  // =============================
  function resetForm(){
    $('playerForm').reset();
    $('playerId').value = '';
    $('formTitle').textContent = 'Add Player';
  }
  function populateForm(playerJson){
    const p = playerJson ? JSON.parse(playerJson) : null;
    if (!p) return;
    $('playerId').value = p.name || '';
    $('name').value = p.name || '';
    $('age').value = p.age ?? '';
    $('position').value = p.position || 'MID';
    $('rating').value = p.rating ?? '';
    $('club').value = p.club || '';
    $('nationality').value = p.nationality || 'ENG';
    $('notes').value = p.notes || '';
    $('formTitle').textContent = 'Edit Player';
    showSection('addEdit');
  }

  async function handlePlayerSubmit(e){
    e.preventDefault();
    const formData = {
      name: $('name').value.trim(),
      ...( $('age').value ? { age: Number($('age').value) } : {} ),
      position: $('position').value,
      ...( $('rating').value ? { rating: Number($('rating').value) } : {} ),
      club: $('club').value.trim(),
      nationality: $('nationality').value,
      ...( $('notes').value.trim() ? { notes: $('notes').value.trim() } : {} ),
    };
    const playerId = $('playerId').value; // original name when editing

    try {
      if (apiMode) {
        const isEdit = Boolean(playerId);
        const url = isEdit ? `${ENDPOINTS.players}/${encodeURIComponent(playerId)}` : ENDPOINTS.players;
        const method = isEdit ? 'PUT' : 'POST';
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData),
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err?.error || `HTTP ${res.status}`);
        }
        alert(`Player ${isEdit ? 'updated' : 'added'} (API mode)`);
        await loadPlayers();
      } else {
        if (playerId) {
          const idx = allPlayers.findIndex(p => p.name === playerId);
          if (idx !== -1) allPlayers[idx] = { ...allPlayers[idx], ...formData };
        } else {
          allPlayers.push(formData);
        }
        displayPlayers(allPlayers);
        updatePlayerCount(allPlayers.length);
        createPositionChart(allPlayers);
        alert(`Player ${playerId ? 'updated' : 'added'} (demo mode)`);
      }
    } catch (err) {
      alert(`Save failed: ${err.message}`);
    }
    resetForm();
    showSection('players');
  }

  async function deletePlayer(nameJson){
    const name = JSON.parse(nameJson);
    if (!confirm(`Delete ${name}?`)) return;
    try {
      if (apiMode) {
        const res = await fetch(`${ENDPOINTS.players}/${encodeURIComponent(name)}`, { method: 'DELETE' });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err?.error || `HTTP ${res.status}`);
        }
        await loadPlayers();
      } else {
        const idx = allPlayers.findIndex(p => p.name === name);
        if (idx !== -1) allPlayers.splice(idx,1);
        displayPlayers(allPlayers);
        updatePlayerCount(allPlayers.length);
        createPositionChart(allPlayers);
      }
    } catch (err) {
      alert(`Delete failed: ${err.message}`);
    }
  }

  // =============================
  // SEARCH & TOGGLE
  // =============================
  async function searchPlayers(query){
    currentSearch = (query || '').trim();
    if (apiMode) {
      currentPage = 1; // reset
      await loadPlayers();
    } else {
      if (!currentSearch) { 
        displayPlayers(allPlayers); 
        createPositionChart(allPlayers);
        return; 
      }
      const q = currentSearch.toLowerCase();
      const filtered = allPlayers.filter(p =>
        (p.name || '').toLowerCase().includes(q) ||
        (p.position || '').toLowerCase().includes(q) ||
        (p.club || '').toLowerCase().includes(q) ||
        (getNationalityName(p.nationality) || '').toLowerCase().includes(q)
      );
      displayPlayers(filtered);
      createPositionChart(filtered);
    }
  }

  function searchScouts(query){
    const q = (query || '').trim().toLowerCase();
    if (!q) {
      displayScouts(allScouts);
      return;
    }
    
    const filtered = allScouts.filter(s =>
      (s.name || '').toLowerCase().includes(q) ||
      (s.region || '').toLowerCase().includes(q) ||
      (s.experience || '').toLowerCase().includes(q) ||
      (s.status || '').toLowerCase().includes(q)
    );
    displayScouts(filtered);
  }
  
  function searchClubs(query){
    const q = (query || '').trim().toLowerCase();
    if (!q) {
      displayClubs(allClubs);
      return;
    }
    
    const filtered = allClubs.filter(c =>
      (c.name || '').toLowerCase().includes(q) ||
      (c.country || '').toLowerCase().includes(q) ||
      (c.league || '').toLowerCase().includes(q)
    );
    displayClubs(filtered);
  }

  function setToggleUI(on){
    const knob = document.getElementById('apiKnob');
    knob.style.transform = on ? 'translateX(20px)' : 'translateX(0)';
  }

  // =============================
  // EVENTS
  // =============================
  document.addEventListener('DOMContentLoaded', () => {
    // Initialize AOS (Animate On Scroll)
    AOS.init({
      duration: 800,
      easing: 'ease-out-quad',
      once: true
    });
    
    // Setup analytics modal
    setupAnalyticsModal();
    
    // Setup analytics tabs
    setupAnalyticsTabs();
    
    // listeners
    $('playerForm').addEventListener('submit', handlePlayerSubmit);
    $('resetFormBtn').addEventListener('click', resetForm);
    $('cancelEditBtn').addEventListener('click', () => {
      resetForm();
      showSection('players');
    });
    $('addPlayerBtn').addEventListener('click', () => {
      resetForm();
      showSection('addEdit');
    });
    $('searchInput').addEventListener('input', (e) => searchPlayers(e.target.value));
    $('scoutSearchInput').addEventListener('input', (e) => searchScouts(e.target.value));
    $('clubSearchInput').addEventListener('input', (e) => searchClubs(e.target.value));
    $('apiToggle').addEventListener('change', async (e) => {
      apiMode = e.target.checked;
      setToggleUI(apiMode);
      await loadPlayers();
    });

    // Navigation click handlers
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = item.getAttribute('href').substring(1);
        showSection(targetId);
      });
    });

    // initial load in demo mode
    allPlayers = [...samplePlayers];
    displayPlayers(allPlayers);
    updatePlayerCount(allPlayers.length);
    createPositionChart(allPlayers);

    // Show the overview section by default
    showSection('overview');

    // Preload charts + API-driven widgets (does not switch to API mode)
    createActivityChart();
    initDashboard();
  });
  </script>
</body>
</html>